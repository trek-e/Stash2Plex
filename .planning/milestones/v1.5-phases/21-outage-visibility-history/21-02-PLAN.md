---
phase: 21-outage-visibility-history
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - Stash2Plex.py
  - Stash2Plex.yml
  - worker/circuit_breaker.py
  - worker/recovery.py
  - worker/processor.py
  - tests/test_main.py
autonomous: true

must_haves:
  truths:
    - "'View Queue Status' task displays circuit breaker state (CLOSED/OPEN/HALF_OPEN) and recovery timing"
    - "'Outage Summary Report' task available in Stash UI shows MTTR, MTBF, availability, recent outages"
    - "Outage start is recorded when CircuitBreaker transitions to OPEN"
    - "Outage end is recorded when RecoveryScheduler detects recovery (circuit closes after outage)"
    - "Status display shows time since last health check and next scheduled check when circuit is OPEN"
    - "Enhanced status display shows last recovery time and total recovery count"
  artifacts:
    - path: "Stash2Plex.py"
      provides: "Enhanced handle_queue_status() and new handle_outage_summary()"
      contains: "handle_outage_summary"
    - path: "Stash2Plex.yml"
      provides: "Outage Summary Report task registration"
      contains: "outage_summary"
    - path: "worker/circuit_breaker.py"
      provides: "Outage history recording on circuit open"
      contains: "outage_history"
    - path: "worker/recovery.py"
      provides: "Outage end recording on recovery complete"
      contains: "outage_history"
  key_links:
    - from: "worker/circuit_breaker.py"
      to: "worker/outage_history.py"
      via: "record_outage_start() called in _open()"
      pattern: "record_outage_start"
    - from: "worker/recovery.py"
      to: "worker/outage_history.py"
      via: "record_outage_end() called in record_health_check()"
      pattern: "record_outage_end"
    - from: "Stash2Plex.py"
      to: "worker/outage_history.py"
      via: "import in handle_queue_status and handle_outage_summary"
      pattern: "from worker\\.outage_history import"
---

<objective>
Wire OutageHistory into circuit breaker lifecycle, enhance queue status display with circuit state/recovery timing, and create outage summary report task.

Purpose: Connects the OutageHistory data layer (Plan 01) to the actual circuit breaker events and exposes outage data through the Stash UI. This completes all three phase requirements (VISB-01, VISB-03, VISB-04).

Output: Enhanced handle_queue_status(), new handle_outage_summary(), outage recording in circuit breaker and recovery scheduler, registered Stash UI task.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-outage-visibility-history/21-RESEARCH.md
@.planning/phases/21-outage-visibility-history/21-01-SUMMARY.md
@Stash2Plex.py
@Stash2Plex.yml
@worker/circuit_breaker.py
@worker/recovery.py
@worker/processor.py
@worker/outage_history.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire outage recording into circuit breaker and recovery lifecycle</name>
  <files>worker/circuit_breaker.py, worker/recovery.py, worker/processor.py</files>
  <action>
    **CircuitBreaker (worker/circuit_breaker.py):**
    - Add optional `outage_history` parameter to __init__ (default None). Store as `self._outage_history`.
    - In `_open()` method, after existing logic and `_save_state_locked()`, add:
      ```python
      if self._outage_history is not None:
          self._outage_history.record_outage_start(self._opened_at)
      ```
    - Do NOT record in _load_state() -- loading persisted OPEN state is not a new outage.

    **RecoveryScheduler (worker/recovery.py):**
    - Add optional `outage_history` parameter to __init__ (default None). Store as `self._outage_history`.
    - In `record_health_check()`, inside the block where recovery is detected (circuit transitions to CLOSED, after `log_info("Recovery detected...")`), add:
      ```python
      if self._outage_history is not None:
          self._outage_history.record_outage_end(state.last_recovery_time)
      ```
    - Note: jobs_affected is passed as 0 for now (counting DLQ entries during outage window is deferred to Phase 22 which has DLQ recovery). This keeps Phase 21 focused on visibility.

    **SyncWorker (worker/processor.py):**
    - In __init__, after the existing circuit breaker initialization block (around line 105-113), create OutageHistory instance:
      ```python
      # Outage history tracking
      if data_dir is not None:
          from worker.outage_history import OutageHistory
          self._outage_history = OutageHistory(data_dir)
      else:
          self._outage_history = None
      ```
    - Pass `outage_history=self._outage_history` to CircuitBreaker constructor.
    - Pass `outage_history=self._outage_history` when creating RecoveryScheduler instances (in _worker_loop where RecoveryScheduler is instantiated).

    NOTE: The RecoveryScheduler in maybe_check_recovery() (Stash2Plex.py) also needs outage_history. But that function creates a new RecoveryScheduler each time. We will handle this in Task 2 by passing outage_history to the RecoveryScheduler created in maybe_check_recovery().

    **Do NOT modify existing tests in this task.** Test changes come in Task 3.
  </action>
  <verify>
    ```bash
    # Verify outage_history parameter exists in CircuitBreaker
    grep -n "outage_history" worker/circuit_breaker.py

    # Verify outage_history parameter exists in RecoveryScheduler
    grep -n "outage_history" worker/recovery.py

    # Verify OutageHistory created in SyncWorker
    grep -n "OutageHistory" worker/processor.py

    # Existing tests still pass (wiring is backward compatible via defaults)
    pytest tests/test_circuit_breaker.py tests/worker/test_recovery.py tests/worker/test_processor.py --tb=short -q
    ```
  </verify>
  <done>
    CircuitBreaker._open() calls record_outage_start(), RecoveryScheduler.record_health_check() calls record_outage_end() on recovery, SyncWorker creates and passes OutageHistory to both. All existing tests pass unchanged (outage_history defaults to None).
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance queue status display and create outage summary report task</name>
  <files>Stash2Plex.py, Stash2Plex.yml</files>
  <action>
    **Enhanced handle_queue_status() (Stash2Plex.py):**
    Add a new section AFTER the existing "=== Reconciliation Status ===" block (before the outer except). Import format_duration, format_elapsed_since from worker.outage_history at point of use.

    Add "=== Circuit Breaker Status ===" section:
    - Read circuit_breaker.json directly (same approach as handle_health_check() already does)
    - Show state: CLOSED / OPEN / HALF_OPEN
    - If OPEN: show "Opened: {format_elapsed_since(opened_at)}" and duration
    - If HALF_OPEN: show "Testing recovery..."

    Add "=== Recovery Status ===" section:
    - Import RecoveryScheduler from worker.recovery
    - Load recovery state from data_dir
    - Show last_check_time as elapsed ("Last health check: 5m 30s ago")
    - If circuit is OPEN and last_check_time > 0: show "Next check: in {5.0 - elapsed:.0f}s" (capped at 0 minimum)
    - Show last_recovery_time if > 0 ("Last recovery: 2h 15m ago")
    - Show recovery_count ("Total recoveries: N")

    Add "=== Recent Outages ===" section:
    - Import OutageHistory from worker.outage_history
    - Load history, show last 3 outages as one-line summaries
    - If current outage ongoing: show "ONGOING ({format_duration(elapsed)})"
    - If no outages: show "No outages recorded"

    **New handle_outage_summary() function (Stash2Plex.py):**
    Create function following the pattern of handle_health_check(). Full implementation:
    - Import OutageHistory, calculate_outage_metrics, format_duration, format_elapsed_since from worker.outage_history
    - Load OutageHistory from data_dir
    - Get all records via get_history()
    - If no records: log "No outages recorded" and return
    - Calculate metrics via calculate_outage_metrics()
    - Log "=== Outage Summary Report ==="
    - Log total outages tracked, completed outages count
    - Log total downtime via format_duration
    - Log MTTR via format_duration (if outage_count > 0)
    - Log MTBF via format_duration (if mtbf > 0)
    - Log availability percentage (if mtbf > 0)
    - Check for ongoing outage via get_current_outage() -- if present, show "ONGOING: started {format_elapsed_since()}"
    - Log "=== Recent Outages ===" header
    - Show last 10 outages (reversed, most recent first) with:
      - Index number
      - Start time as datetime string (YYYY-MM-DD HH:MM:SS)
      - Duration or "ONGOING"
      - Jobs affected count if > 0
    - Log "=== End Report ==="
    - Wrap in try/except, log_error on failure

    **Register in dispatch table:**
    Add to _MANAGEMENT_HANDLERS dict:
    ```python
    'outage_summary': lambda args: handle_outage_summary(),
    ```

    **Update management_modes set** in main() (around line 1297) to include 'outage_summary'.

    **Update maybe_check_recovery():**
    - Create OutageHistory instance from data_dir and pass to the RecoveryScheduler:
      ```python
      from worker.outage_history import OutageHistory
      outage_history = OutageHistory(data_dir)
      scheduler = RecoveryScheduler(data_dir, outage_history=outage_history)
      ```

    **Stash2Plex.yml:**
    Add new task entry after the "Health Check" task:
    ```yaml
    - name: Outage Summary Report
      description: Show outage history, MTTR, MTBF, and availability statistics
      defaultArgs:
        mode: outage_summary
    ```
  </action>
  <verify>
    ```bash
    # Verify new handler exists
    grep -n "handle_outage_summary" Stash2Plex.py

    # Verify dispatch table entry
    grep -n "outage_summary" Stash2Plex.py

    # Verify task registered in YAML
    grep -n "outage_summary" Stash2Plex.yml

    # Verify circuit breaker status in queue status handler
    grep -n "Circuit Breaker Status" Stash2Plex.py

    # Verify management_modes includes outage_summary
    grep "outage_summary" Stash2Plex.py

    # Python syntax check
    python3 -c "import ast; ast.parse(open('Stash2Plex.py').read()); print('Syntax OK')"
    ```
  </verify>
  <done>
    handle_queue_status() shows circuit breaker state, recovery timing, health check timing, and recent outages. handle_outage_summary() shows detailed metrics (MTTR, MTBF, availability) and last 10 outages. Task registered in Stash2Plex.yml. maybe_check_recovery() passes outage_history to RecoveryScheduler.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for wiring and UI handlers</name>
  <files>tests/test_main.py, tests/test_circuit_breaker.py, tests/worker/test_recovery.py</files>
  <action>
    **tests/test_circuit_breaker.py:**
    Add test class TestCircuitBreakerOutageHistory (3-4 tests):
    - test_open_records_outage_start: Create CircuitBreaker with mock outage_history, trigger _open() via enough record_failure() calls, assert outage_history.record_outage_start was called with opened_at timestamp
    - test_open_without_outage_history: Create CircuitBreaker(outage_history=None), trigger _open(), no error (backward compatible)
    - test_outage_history_parameter_stored: Create with outage_history=mock, verify self._outage_history is set

    **tests/worker/test_recovery.py:**
    Add test class TestRecoveryOutageHistory (3-4 tests):
    - test_recovery_records_outage_end: Create RecoveryScheduler with mock outage_history, simulate successful recovery (call record_health_check with success=True and mock circuit_breaker transitioning HALF_OPEN->CLOSED), assert outage_history.record_outage_end was called
    - test_recovery_without_outage_history: RecoveryScheduler(data_dir, outage_history=None), simulate recovery, no error
    - test_no_outage_end_when_circuit_stays_open: record_health_check with success=False, assert record_outage_end NOT called

    **tests/test_main.py:**
    Add tests for the new/enhanced handlers (4-6 tests):
    - test_handle_outage_summary_no_outages: Mock OutageHistory with empty history, verify "No outages recorded" logged
    - test_handle_outage_summary_with_outages: Mock OutageHistory with sample records, verify metrics logged (MTTR, total downtime, etc.)
    - test_handle_queue_status_includes_circuit_breaker_section: Mock the circuit_breaker.json file, run handle_queue_status(), verify "Circuit Breaker Status" appears in log output
    - test_outage_summary_in_management_handlers: Verify 'outage_summary' key exists in _MANAGEMENT_HANDLERS
    - test_outage_summary_in_management_modes: Verify 'outage_summary' in management_modes set

    Follow existing test patterns in tests/test_main.py -- check how handle_health_check and handle_queue_status are tested. Use same mocking approach (mock log_info, mock file reads, etc.).

    All tests should be self-contained with tmp_path fixtures for data_dir.
  </action>
  <verify>
    ```bash
    # Run new tests
    pytest tests/test_circuit_breaker.py::TestCircuitBreakerOutageHistory -v --tb=short
    pytest tests/worker/test_recovery.py::TestRecoveryOutageHistory -v --tb=short
    pytest tests/test_main.py -k "outage" -v --tb=short

    # Full suite
    pytest --tb=short -q

    # Coverage check
    pytest --cov --cov-report=term-missing --tb=short -q 2>&1 | tail -5
    ```
  </verify>
  <done>
    Tests verify: CircuitBreaker._open() calls record_outage_start(), RecoveryScheduler.record_health_check() calls record_outage_end() on recovery, handle_outage_summary() displays metrics, handle_queue_status() includes circuit breaker section. All tests pass. Full suite 1136+ tests. Coverage above 80%.
  </done>
</task>

</tasks>

<verification>
```bash
# Phase-level verification: all requirements met

# VISB-01: Queue status shows circuit state and recovery timing
grep -n "Circuit Breaker Status" Stash2Plex.py
grep -n "Recovery Status" Stash2Plex.py

# VISB-03: Outage history tracks last 30 outages
grep -n "MAX_OUTAGES = 30" worker/outage_history.py
grep -n "record_outage_start" worker/circuit_breaker.py
grep -n "record_outage_end" worker/recovery.py

# VISB-04: Outage summary report task
grep -n "outage_summary" Stash2Plex.yml
grep -n "handle_outage_summary" Stash2Plex.py

# Full test suite passes
pytest --tb=short -q

# Coverage above threshold
pytest --cov --cov-report=term-missing --tb=short -q 2>&1 | tail -5
```
</verification>

<success_criteria>
- "View Queue Status" task shows circuit breaker state (CLOSED/OPEN/HALF_OPEN), recovery timing, health check timing, and recent outages
- Outage start recorded when circuit opens (CircuitBreaker._open)
- Outage end recorded when recovery completes (RecoveryScheduler.record_health_check)
- "Outage Summary Report" task shows MTTR, MTBF, availability, total downtime, and last 10 outages
- Task registered in Stash2Plex.yml and dispatch table
- All new + existing tests pass (1136+ total)
- Coverage above 80%
</success_criteria>

<output>
After completion, create `.planning/phases/21-outage-visibility-history/21-02-SUMMARY.md`
</output>
