# Milestone v1.5: Outage Resilience

**Status:** SHIPPED 2026-02-24
**Phases:** 17-22
**Total Plans:** 12

## Overview

Automatic recovery when Plex comes back online after downtime — queue drains without user interaction, circuit breaker state persists across restarts, and health monitoring provides visibility into outage/recovery status.

## Phases

### Phase 17: Circuit Breaker Persistence
**Goal**: Circuit breaker state persists across plugin restarts, preventing reset-to-CLOSED during outages
**Depends on**: Phase 16 (v1.4 complete)
**Requirements**: STAT-01, VISB-02
**Plans**: 2 plans

Plans:
- [x] 17-01: TDD: Circuit breaker persistence, transition logging, and file locking
- [x] 17-02: Wire state_file into SyncWorker and add integration tests

### Phase 18: Health Check Infrastructure
**Goal**: Lightweight Plex connectivity check validates server is reachable and responsive
**Depends on**: Phase 17
**Requirements**: HLTH-01, HLTH-02, HLTH-03
**Plans**: 2 plans

Plans:
- [x] 18-01: TDD: Deep health check function using server.query('/identity')
- [x] 18-02: Manual health check task + active health probes in worker loop

### Phase 19: Recovery Detection & Automation
**Goal**: Plugin automatically detects when Plex recovers from outage and drains pending queue without user interaction
**Depends on**: Phase 18
**Requirements**: RECV-01, RECV-02, RECV-03, STAT-02
**Plans**: 2 plans

Plans:
- [x] 19-01: TDD: RecoveryScheduler with check-on-invocation pattern and state persistence
- [x] 19-02: Wire maybe_check_recovery() into main loop with integration tests

### Phase 20: Graduated Recovery & Rate Limiting
**Goal**: Queue draining after recovery uses graduated rate limiting to avoid overwhelming just-recovered Plex server
**Depends on**: Phase 19
**Requirements**: RECV-04
**Plans**: 2 plans

Plans:
- [x] 20-01: TDD: RecoveryRateLimiter with token bucket, graduated scaling, and error monitoring
- [x] 20-02: Wire rate limiter into worker loop with integration tests

### Phase 21: Outage Visibility & History
**Goal**: Queue status UI shows circuit state, recovery timing, and outage history for debugging
**Depends on**: Phase 20
**Requirements**: VISB-01, VISB-03, VISB-04
**Plans**: 2 plans

Plans:
- [x] 21-01: TDD: OutageHistory manager with circular buffer, time formatting, and metrics calculation
- [x] 21-02: Wire outage recording, enhance queue status display, create outage summary task

### Phase 22: DLQ Recovery for Outage Jobs
**Goal**: Re-queue DLQ entries with transient errors from outage windows, enabling recovery of jobs that failed during Plex downtime
**Depends on**: Phase 21
**Requirements**: DLQM-01, DLQM-02
**Plans**: 2 plans

Plans:
- [x] 22-01: TDD: DLQ recovery module with error classification, time-windowed queries, and idempotent recovery
- [x] 22-02: Wire recovery task into Stash UI with handler, registration, and tests

## Milestone Summary

**Key Decisions:**
- state_file=None default for 100% backward compatibility
- Non-blocking advisory locking (LOCK_NB) makes save skippable, not blocking
- Corrupted state defaults to CLOSED (safe, not stuck-open)
- Health checks do NOT directly modify circuit breaker state (avoids race conditions)
- Health check timeout is 5s (not 30s read_timeout) to avoid blocking worker thread
- Recovery detection only runs during OPEN/HALF_OPEN states, not CLOSED
- Token bucket capacity 1.0 for minimal burst, linear interpolation for rate scaling
- Circular buffer with maxlen=30 for automatic oldest-record eviction
- Conservative default: only PlexServerDown errors recovered by default

**Issues Resolved:**
- Circuit breaker reset on restart during outage (state now persists)
- No way to detect Plex recovery without manual intervention (active health checks)
- Queue thundering herd after recovery (graduated rate limiting)
- DLQ jobs from outages stuck permanently (recovery task)

**Issues Deferred:**
- Outage-triggered reconciliation (RECV-05) — deferred to future milestone
- Per-error-type configurable recovery strategies (RECV-06) — deferred to future milestone

**Technical Debt Incurred:**
- jobs_affected passed as 0 in outage recording (counting deferred, not yet wired)

---

_For current project status, see .planning/ROADMAP.md_
