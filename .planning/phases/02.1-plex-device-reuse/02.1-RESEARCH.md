# Phase 2.1: Fix Plex Device Registration - Research

**Researched:** 2026-02-03
**Domain:** PlexAPI device identification / X-Plex-Client-Identifier
**Confidence:** HIGH

## Summary

This research investigates how to prevent Plex "new device" notifications when PlexSync connects to the Plex server. The root cause is that each connection uses a different `X-Plex-Client-Identifier` header value because the default is generated from `uuid.getnode()` (MAC address in hex), which can vary or be regenerated.

The standard approach is to generate a persistent UUID once and reuse it across all connections. PlexAPI supports three methods for customizing this identifier: environment variables, config file, or programmatic module-level override. For PlexSync, the recommended approach is to generate and persist a UUID in the plugin's `data_dir` (as JSON), then set it programmatically via `plexapi.X_PLEX_IDENTIFIER` before creating any `PlexServer` connections.

**Primary recommendation:** Generate a UUID on first run, persist it to `data_dir/device_id.json`, and set `plexapi.X_PLEX_IDENTIFIER` before importing `PlexServer`.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| plexapi | latest (Jan 2026) | Plex API communication | Already in use by PlexSync |
| uuid | stdlib | Generate unique identifiers | Python standard library, no dependencies |
| json | stdlib | Persist device identifier | Already used for sync_timestamps.json |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| os | stdlib | File path operations | Check for existing device_id file |
| pathlib | stdlib | Path manipulation | Optional cleaner syntax |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| JSON file | SQLite | Overkill for single value, JSON is simpler |
| Module-level override | Config file (~/.config/plexapi/config.ini) | Config file affects ALL plexapi usage on system, not just PlexSync |
| Module-level override | Environment variable | Requires external config, less self-contained |

**Installation:**
No new packages needed. Uses existing `plexapi` and Python standard library.

## Architecture Patterns

### Recommended Project Structure
```
plex/
├── client.py           # PlexClient - add device identifier setup
├── device_identity.py  # NEW: Device ID generation/loading
├── exceptions.py       # Existing exception handling
└── __init__.py
```

### Pattern 1: Lazy Device ID Initialization
**What:** Generate device ID on first access, persist for future use
**When to use:** When you need consistent identity across restarts without upfront setup
**Example:**
```python
# Source: Verified plexapi pattern from official docs
import plexapi
import uuid
import json
import os

def get_or_create_device_id(data_dir: str) -> str:
    """Load existing device ID or generate new one."""
    id_file = os.path.join(data_dir, 'device_id.json')

    if os.path.exists(id_file):
        with open(id_file, 'r') as f:
            data = json.load(f)
            return data['device_id']

    # Generate new UUID (v4 is random, good for device IDs)
    device_id = str(uuid.uuid4())

    with open(id_file, 'w') as f:
        json.dump({'device_id': device_id}, f)

    return device_id

def configure_plex_identity(data_dir: str) -> None:
    """Set plexapi module-level identifier before any PlexServer connections."""
    device_id = get_or_create_device_id(data_dir)
    plexapi.X_PLEX_IDENTIFIER = device_id
    # Also update product name for better identification in Plex UI
    plexapi.X_PLEX_PRODUCT = 'PlexSync'
    plexapi.X_PLEX_DEVICE_NAME = 'PlexSync Plugin'
```

### Pattern 2: Early Initialization
**What:** Configure device identity before any plexapi imports that create connections
**When to use:** Critical for ensuring all connections use the same identifier
**Example:**
```python
# In PlexSync.py - BEFORE creating PlexClient
from plex.device_identity import configure_plex_identity

def main():
    data_dir = get_plugin_data_dir()
    configure_plex_identity(data_dir)  # MUST be before PlexClient creation

    # Now safe to create PlexClient
    client = PlexClient(url=config.plex_url, token=config.plex_token)
```

### Anti-Patterns to Avoid
- **Setting identifier AFTER PlexServer creation:** The identifier is captured when `PlexServer.__init__` runs. Changing it later has no effect on existing connections.
- **Using plexapi's global config.ini:** Affects all plexapi usage system-wide, not just this plugin.
- **Generating new UUID on each connection:** The exact problem we're fixing.
- **Using MAC-based identifiers:** Can change when network interfaces change; UUID4 is more stable.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| UUID generation | Custom random string | `uuid.uuid4()` | Cryptographically strong, proper format |
| JSON file read/write | Raw file operations | `json.load()`/`json.dump()` | Handles encoding, atomicity |
| Plex header management | Custom requests.Session | `plexapi.X_PLEX_IDENTIFIER` | PlexAPI handles header propagation |

**Key insight:** PlexAPI already provides the mechanism to customize device identity. The only custom code needed is persistence of the identifier across plugin restarts.

## Common Pitfalls

### Pitfall 1: Import Order Matters
**What goes wrong:** Setting `plexapi.X_PLEX_IDENTIFIER` after importing `PlexServer` has no effect because headers are captured at import time.
**Why it happens:** `BASE_HEADERS = reset_base_headers()` runs at module load, capturing the current `X_PLEX_IDENTIFIER` value.
**How to avoid:** Set `plexapi.X_PLEX_IDENTIFIER` BEFORE any `from plexapi.server import PlexServer`.
**Warning signs:** "New device" notifications continue despite setting identifier.

### Pitfall 2: File Permissions
**What goes wrong:** Device ID file not readable/writable by plugin.
**Why it happens:** Plugin runs as different user, or data_dir doesn't exist.
**How to avoid:** Use `os.makedirs(data_dir, exist_ok=True)` before writing.
**Warning signs:** FileNotFoundError or PermissionError on first run.

### Pitfall 3: Corrupted JSON File
**What goes wrong:** Plugin crashes on startup if device_id.json is malformed.
**Why it happens:** Interrupted write, manual editing.
**How to avoid:** Wrap load in try/except, regenerate if corrupt.
**Warning signs:** JSONDecodeError exceptions.

### Pitfall 4: Inconsistent Device Name in Plex UI
**What goes wrong:** Plex shows generic device name even with persistent identifier.
**Why it happens:** Only setting identifier, not product name or device name.
**How to avoid:** Also set `X_PLEX_PRODUCT` and `X_PLEX_DEVICE_NAME` for better UX.
**Warning signs:** Plex shows "PlexAPI" or hostname instead of "PlexSync".

## Code Examples

Verified patterns from official sources:

### Loading Existing Device ID with Error Handling
```python
# Source: PlexAPI docs + defensive coding patterns
import json
import os
import uuid
import logging

logger = logging.getLogger('PlexSync.device')

def load_or_create_device_id(data_dir: str) -> str:
    """
    Load persistent device ID or create new one.

    The device ID ensures Plex recognizes PlexSync as the same
    device across restarts, avoiding "new device" notifications.
    """
    id_file = os.path.join(data_dir, 'device_id.json')

    # Try to load existing
    if os.path.exists(id_file):
        try:
            with open(id_file, 'r') as f:
                data = json.load(f)
                device_id = data.get('device_id')
                if device_id:
                    logger.debug(f"Loaded existing device ID: {device_id[:8]}...")
                    return device_id
        except (json.JSONDecodeError, KeyError, IOError) as e:
            logger.warning(f"Corrupt device_id.json, regenerating: {e}")

    # Generate new UUID v4
    device_id = str(uuid.uuid4())
    logger.info(f"Generated new device ID: {device_id[:8]}...")

    # Persist for future use
    os.makedirs(data_dir, exist_ok=True)
    with open(id_file, 'w') as f:
        json.dump({'device_id': device_id}, f, indent=2)

    return device_id
```

### Complete Device Identity Setup
```python
# Source: Verified from plexapi/__init__.py structure
import plexapi
import plexapi.config

def configure_plex_device_identity(data_dir: str) -> str:
    """
    Configure plexapi module-level variables for device identification.

    MUST be called before any PlexServer connections are created.

    Returns:
        The device ID being used
    """
    device_id = load_or_create_device_id(data_dir)

    # Set module-level variables (affects all future connections)
    plexapi.X_PLEX_IDENTIFIER = device_id
    plexapi.X_PLEX_PRODUCT = 'PlexSync'
    plexapi.X_PLEX_DEVICE_NAME = 'PlexSync Plugin'

    # Rebuild BASE_HEADERS to pick up new values
    plexapi.BASE_HEADERS = plexapi.config.reset_base_headers()

    return device_id
```

### Integration Point in PlexSync.py
```python
# Early in main() or handle_hook() - before PlexClient creation
from plex.device_identity import configure_plex_device_identity

def initialize_plex_connection():
    """Set up Plex connection with persistent device identity."""
    data_dir = get_plugin_data_dir()

    # CRITICAL: Must happen before PlexClient is created
    device_id = configure_plex_device_identity(data_dir)
    log_info(f"Using Plex device ID: {device_id[:8]}...")

    # Now safe to create client
    return PlexClient(url=config.plex_url, token=config.plex_token)
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Accept default MAC-based ID | Persist UUID for consistent identity | Best practice since plexapi 4.x | Eliminates new device notifications |
| Config file in ~/.config | Module-level override | Always available | Plugin-specific, doesn't affect system |

**Deprecated/outdated:**
- None - the plexapi configuration mechanism has been stable since v4.x

## Open Questions

Things that couldn't be fully resolved:

1. **BASE_HEADERS refresh necessity**
   - What we know: Setting `plexapi.X_PLEX_IDENTIFIER` changes the module variable
   - What's unclear: Whether `BASE_HEADERS` is automatically regenerated or needs explicit `reset_base_headers()` call
   - Recommendation: Call `plexapi.BASE_HEADERS = plexapi.config.reset_base_headers()` after setting identifier to be safe

2. **Multiple Plex servers**
   - What we know: The identifier is global to the plexapi module
   - What's unclear: If connecting to multiple Plex servers, should they use the same ID?
   - Recommendation: Use same ID (represents the PlexSync plugin, not the server)

## Sources

### Primary (HIGH confidence)
- [python-plexapi GitHub repository](https://github.com/pkkid/python-plexapi) - Module structure and header handling
- [python-plexapi configuration docs](https://python-plexapi.readthedocs.io/en/stable/configuration.html) - All config options including header.identifier
- `/Users/trekkie/projects/PlexSync/.venv/lib/python3.14/site-packages/plexapi/__init__.py` - Verified X_PLEX_IDENTIFIER definition and CONFIG loading
- `/Users/trekkie/projects/PlexSync/.venv/lib/python3.14/site-packages/plexapi/config.py` - Verified reset_base_headers() function

### Secondary (MEDIUM confidence)
- [PlexAPI configuration.rst](https://github.com/pkkid/python-plexapi/blob/master/docs/configuration.rst) - Full config.ini example with all header options

### Tertiary (LOW confidence)
- None - all claims verified with official sources

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Verified with installed plexapi source code
- Architecture: HIGH - Pattern derived from plexapi module structure
- Pitfalls: HIGH - Import order verified by code inspection

**Research date:** 2026-02-03
**Valid until:** 2026-05-03 (plexapi is stable, patterns unlikely to change)
