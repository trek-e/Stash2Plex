---
phase: 10-metadata-sync-toggles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - validation/config.py
  - PlexSync.yml
autonomous: true

must_haves:
  truths:
    - "PlexSyncConfig accepts 10 new boolean fields (sync_master + 9 individual)"
    - "All toggle fields default to True (enabled)"
    - "Boolean string coercion works for toggle fields ('true'/'false' strings)"
    - "Stash UI shows new Field Sync settings section"
  artifacts:
    - path: "validation/config.py"
      provides: "10 sync toggle boolean fields with defaults"
      contains: "sync_master"
    - path: "PlexSync.yml"
      provides: "Stash plugin settings UI entries"
      contains: "sync_studio"
  key_links:
    - from: "validation/config.py"
      to: "PlexSync.yml"
      via: "Setting key names must match exactly"
      pattern: "sync_(master|studio|summary|tagline|date|performers|tags|poster|background|collection)"
---

<objective>
Add field sync toggle configuration to PlexSyncConfig and Stash plugin settings UI.

Purpose: Enable users to configure which metadata fields sync from Stash to Plex via plugin settings.
Output: 10 boolean toggle fields in config model and corresponding Stash UI settings.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-metadata-sync-toggles/10-CONTEXT.md
@.planning/phases/10-metadata-sync-toggles/10-RESEARCH.md

# Source files to modify
@validation/config.py
@PlexSync.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toggle fields to PlexSyncConfig</name>
  <files>validation/config.py</files>
  <action>
Add 10 boolean fields to PlexSyncConfig class after the existing `preserve_plex_edits` field:

```python
# =========================================================================
# Field Sync Toggles (all default True = enabled)
# =========================================================================

sync_master: bool = Field(
    default=True,
    description="Master toggle to enable/disable all metadata field syncing"
)
sync_studio: bool = Field(
    default=True,
    description="Sync studio name from Stash to Plex"
)
sync_summary: bool = Field(
    default=True,
    description="Sync summary/details from Stash to Plex"
)
sync_tagline: bool = Field(
    default=True,
    description="Sync tagline from Stash to Plex"
)
sync_date: bool = Field(
    default=True,
    description="Sync release date from Stash to Plex"
)
sync_performers: bool = Field(
    default=True,
    description="Sync performers as Plex actors"
)
sync_tags: bool = Field(
    default=True,
    description="Sync tags as Plex genres"
)
sync_poster: bool = Field(
    default=True,
    description="Sync poster image from Stash to Plex"
)
sync_background: bool = Field(
    default=True,
    description="Sync background/fanart image from Stash to Plex"
)
sync_collection: bool = Field(
    default=True,
    description="Add items to Plex collection based on studio name"
)
```

Update the existing `validate_booleans` field_validator decorator to include all 10 new fields:

```python
@field_validator(
    'strict_matching', 'preserve_plex_edits',
    'sync_master', 'sync_studio', 'sync_summary', 'sync_tagline',
    'sync_date', 'sync_performers', 'sync_tags', 'sync_poster',
    'sync_background', 'sync_collection',
    mode='before'
)
@classmethod
def validate_booleans(cls, v):
    # ... existing implementation unchanged ...
```

Update `log_config()` method to log toggle settings (grouped summary, not 10 lines):

```python
# Add after existing log line:
toggles_off = [k.replace('sync_', '') for k in [
    'sync_studio', 'sync_summary', 'sync_tagline', 'sync_date',
    'sync_performers', 'sync_tags', 'sync_poster', 'sync_background', 'sync_collection'
] if not getattr(self, k, True)]
if not self.sync_master:
    log.info(f"Field sync: MASTER OFF (all fields disabled)")
elif toggles_off:
    log.info(f"Field sync: enabled except {toggles_off}")
else:
    log.info(f"Field sync: all fields enabled")
```
  </action>
  <verify>
Run existing config tests: `pytest tests/validation/test_config.py -v`
All existing tests should pass (no breakage from new optional fields).
  </verify>
  <done>
PlexSyncConfig has 10 new boolean fields (sync_master + 9 individual), all defaulting to True, with string coercion via validate_booleans validator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add toggle settings to PlexSync.yml</name>
  <files>PlexSync.yml</files>
  <action>
Add a new settings section for Field Sync toggles at the end of the existing `settings:` block.

**CRITICAL:** Setting key names MUST match exactly the Python field names (snake_case).

Add these entries after the existing `read_timeout` setting:

```yaml
  # ----- Field Sync Settings -----
  sync_master:
    displayName: "Enable Field Sync"
    description: "Master toggle - when OFF, no metadata fields are synced"
    type: BOOLEAN
  sync_studio:
    displayName: "Sync Studio"
    description: "Sync studio name from Stash to Plex"
    type: BOOLEAN
  sync_summary:
    displayName: "Sync Summary"
    description: "Sync description/details from Stash to Plex"
    type: BOOLEAN
  sync_tagline:
    displayName: "Sync Tagline"
    description: "Sync tagline from Stash to Plex"
    type: BOOLEAN
  sync_date:
    displayName: "Sync Date"
    description: "Sync release date from Stash to Plex"
    type: BOOLEAN
  sync_performers:
    displayName: "Sync Performers"
    description: "Sync performers as actors in Plex"
    type: BOOLEAN
  sync_tags:
    displayName: "Sync Tags"
    description: "Sync tags as genres in Plex"
    type: BOOLEAN
  sync_poster:
    displayName: "Sync Poster"
    description: "Sync poster image from Stash to Plex"
    type: BOOLEAN
  sync_background:
    displayName: "Sync Background"
    description: "Sync background/fanart image from Stash to Plex"
    type: BOOLEAN
  sync_collection:
    displayName: "Sync Collection"
    description: "Add items to Plex collection based on studio name"
    type: BOOLEAN
```

Verify each setting key matches the corresponding Python field name exactly.
  </action>
  <verify>
YAML syntax check: `python -c "import yaml; yaml.safe_load(open('PlexSync.yml'))"`
Count settings: should now have 20 total settings entries (10 existing + 10 new).
  </verify>
  <done>
PlexSync.yml contains 10 new Field Sync settings with BOOLEAN type, grouped together with descriptive help text.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add config toggle validation tests</name>
  <files>tests/validation/test_config.py</files>
  <action>
Add a new test class `TestSyncToggles` to test_config.py with these tests:

```python
class TestSyncToggles:
    """Tests for field sync toggle configuration."""

    def test_all_toggles_default_true(self):
        """All sync toggles should default to True (enabled)."""
        config = PlexSyncConfig(plex_url="http://test:32400", plex_token="valid_token_here")
        assert config.sync_master is True
        assert config.sync_studio is True
        assert config.sync_summary is True
        assert config.sync_tagline is True
        assert config.sync_date is True
        assert config.sync_performers is True
        assert config.sync_tags is True
        assert config.sync_poster is True
        assert config.sync_background is True
        assert config.sync_collection is True

    def test_toggle_accepts_boolean_true(self):
        """Toggle fields accept Python boolean True."""
        config = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_studio=True,
        )
        assert config.sync_studio is True

    def test_toggle_accepts_boolean_false(self):
        """Toggle fields accept Python boolean False."""
        config = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_studio=False,
        )
        assert config.sync_studio is False

    def test_toggle_accepts_string_true(self):
        """Toggle fields accept string 'true' (Stash settings format)."""
        config = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_studio="true",
        )
        assert config.sync_studio is True

    def test_toggle_accepts_string_false(self):
        """Toggle fields accept string 'false' (Stash settings format)."""
        config = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_studio="false",
        )
        assert config.sync_studio is False

    def test_toggle_accepts_numeric_string(self):
        """Toggle fields accept '1' and '0' strings."""
        config_on = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_performers="1",
        )
        config_off = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_performers="0",
        )
        assert config_on.sync_performers is True
        assert config_off.sync_performers is False

    def test_all_toggles_can_be_disabled(self):
        """All sync toggles can be individually disabled."""
        config = PlexSyncConfig(
            plex_url="http://test:32400",
            plex_token="valid_token_here",
            sync_master=False,
            sync_studio=False,
            sync_summary=False,
            sync_tagline=False,
            sync_date=False,
            sync_performers=False,
            sync_tags=False,
            sync_poster=False,
            sync_background=False,
            sync_collection=False,
        )
        assert config.sync_master is False
        assert config.sync_studio is False
        # ... all should be False

    def test_invalid_toggle_value_raises(self):
        """Invalid toggle value should raise validation error."""
        import pytest
        from pydantic import ValidationError
        with pytest.raises(ValidationError):
            PlexSyncConfig(
                plex_url="http://test:32400",
                plex_token="valid_token_here",
                sync_studio="invalid",
            )
```

Import `PlexSyncConfig` and `ValidationError` at the top of the file if not already imported.
  </action>
  <verify>
Run toggle tests: `pytest tests/validation/test_config.py::TestSyncToggles -v`
All 8 tests should pass.
Run full config test suite: `pytest tests/validation/test_config.py -v`
All tests should pass.
  </verify>
  <done>
TestSyncToggles class with 8 tests verifying toggle defaults, boolean/string coercion, and validation.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/validation/test_config.py -v` - all tests pass including new toggle tests
2. `python -c "import yaml; yaml.safe_load(open('PlexSync.yml'))"` - YAML valid
3. `python -c "from validation.config import PlexSyncConfig; c = PlexSyncConfig(plex_url='http://x:32400', plex_token='xxxxxxxxxxxx'); print(c.sync_master, c.sync_studio)"` - prints `True True`
</verification>

<success_criteria>
- PlexSyncConfig has 10 new sync toggle fields, all defaulting to True
- String coercion works ('true'/'false'/'1'/'0')
- PlexSync.yml has 10 matching settings with BOOLEAN type
- 8+ new tests pass for toggle validation
</success_criteria>

<output>
After completion, create `.planning/phases/10-metadata-sync-toggles/10-01-SUMMARY.md`
</output>
