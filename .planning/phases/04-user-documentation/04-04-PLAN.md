---
phase: 04-user-documentation
plan: 04
type: execute
wave: 2
depends_on: ["04-03"]
files_modified:
  - docs/troubleshoot.md
autonomous: true

must_haves:
  truths:
    - "Top 8 common issues documented with solutions"
    - "User can interpret log output without external help"
    - "Queue/retry/DLQ system explained at user level"
    - "User knows how to report issues with proper template"
  artifacts:
    - path: "docs/troubleshoot.md"
      provides: "Troubleshooting guide with log interpretation"
      min_lines: 200
      contains: "## Common Issues"
  key_links:
    - from: "docs/troubleshoot.md"
      to: "docs/config.md"
      via: "markdown link"
      pattern: "\\[.*\\]\\(config\\.md\\)"
---

<objective>
Create troubleshooting guide covering common issues, log interpretation, and how to report bugs.

Purpose: Enable users to diagnose and resolve issues without external help
Output: docs/troubleshoot.md
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-documentation/04-CONTEXT.md
@.planning/phases/04-user-documentation/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs/troubleshoot.md</name>
  <files>docs/troubleshoot.md</files>
  <action>
Create docs/troubleshoot.md with the following structure:

1. **Title**
   - "# Troubleshooting Guide"
   - Brief intro: How to diagnose and resolve common PlexSync issues

2. **How PlexSync Works** (brief context for troubleshooting)
   Explain the flow so users understand where issues occur:
   - Hook receives scene update from Stash (fast, <100ms)
   - Job added to persistent queue (survives restarts)
   - Background worker processes queue every 30 seconds
   - Worker retries on transient failures (network, Plex down)
   - Permanent failures go to dead letter queue (DLQ)

   Key insight: Updates are NOT instant - there's a queue processing delay.

3. **Reading the Logs**
   Explain Stash plugin log format:
   - Where to find logs: Stash > Settings > Logs (or `logs/` folder)
   - Filter by: `[PlexSync]` prefix
   - Log levels:
     - `t` (trace): Very detailed debug info
     - `d` (debug): Debug information
     - `i` (info): Normal operations
     - `w` (warning): Non-fatal issues
     - `e` (error): Failures

   **Example Success Flow:**
   ```
   [PlexSync] Initialization complete
   [PlexSync Hook] Enqueued sync job for scene 123 in 45.2ms
   [PlexSync Worker] Processing job 456 for scene 123 (attempt 1)
   [PlexSync Matcher] Searching 'Adult' for: Scene Name - 2026-01-30.mp4
   [PlexSync Matcher] Title search: 'Scene Name'
   [PlexSync Matcher] Got 1 title matches
   [PlexSync Matcher] Found: Scene Name
   [PlexSync Worker] Updated metadata (overwrite mode): Scene Name
   [PlexSync Worker] Added 2 performers: ['Performer A', 'Performer B']
   [PlexSync Worker] Job 456 completed
   ```

   Annotate: What each line means, timing expectations.

4. **Common Issues** (top 8 from RESEARCH.md)

   **Issue 1: Plex token invalid/expired**
   - Symptom: `Authentication failed: Unauthorized` in logs
   - Cause: Token expired or incorrect
   - Solution: Get a fresh token (see [Installation Guide](install.md#getting-your-plex-token))
   - Related setting: `plex_token` in [config.md](config.md)

   **Issue 2: No Plex match found**
   - Symptom: `PlexNotFound: No Plex item found for filename`
   - Causes:
     - File not scanned by Plex yet
     - Path mismatch between Stash and Plex (common in Docker)
     - Library not specified (searching wrong library)
   - Solutions:
     - Scan Plex library: Library > ... > Scan Library Files
     - Verify paths match (see Docker section below)
     - Set `plex_library` to specific library name
   - Note: PlexNotFound retries automatically (up to 12 times over ~2 hours for library scanning)

   **Issue 3: Multiple Plex matches (strict mode)**
   - Symptom: `Low confidence match skipped (strict_matching=true)`
   - Cause: Multiple Plex items match the filename
   - Solutions:
     - Option A: Set `strict_matching: false` to use first match
     - Option B: Rename files to be more unique
   - Trade-off: Relaxed matching may sync to wrong item

   **Issue 4: Queue processing timeout**
   - Symptom: `Timeout waiting for queue (X items remaining)` or processing stops mid-queue
   - Cause: Stash plugin execution time limit
   - Solutions:
     - Wait for next scheduled sync
     - Use `Sync Recent Scenes` task for smaller batches
     - For large backlogs, run `process_queue.py` manually (see below)

   **Issue 5: Scene has no file path**
   - Symptom: `No file path for scene X, cannot sync to Plex`
   - Cause: Scene in Stash without associated media file
   - Solution: Link files to scene in Stash, or skip scenes without files

   **Issue 6: Hook handler slow**
   - Symptom: `Hook handler exceeded 100ms target (156.3ms)`
   - Cause: Slow Stash GraphQL or network latency
   - Impact: Non-blocking warning; sync still works
   - Solution: Usually ignore; if persistent, check Stash performance

   **Issue 7: Circuit breaker opened**
   - Symptom: `Circuit breaker OPENED - pausing processing`
   - Cause: 5+ consecutive Plex failures
   - Meaning: PlexSync paused to avoid hammering a failing Plex server
   - Resolution: Auto-recovers after 60 seconds
   - If persistent: Check Plex server is running and accessible

   **Issue 8: DLQ has failed jobs**
   - Symptom: `DLQ contains X failed jobs requiring review`
   - Meaning: Some jobs failed permanently and won't retry
   - Action: Check logs for specific errors on each job
   - Common causes: Auth failure (401), bad request (400), missing file

5. **Docker Path Mapping Issues**
   Dedicated section since this is a common source of confusion:

   PlexSync matches files by path. If Stash and Plex see different paths, matching fails.

   **Example Problem:**
   - Stash sees: `/data/videos/scene.mp4`
   - Plex sees: `/media/videos/scene.mp4`
   - Result: No match found

   **Solution:** Ensure both containers mount media at the SAME path:
   ```yaml
   # docker-compose.yml example
   stash:
     volumes:
       - /mnt/media:/media  # Use /media inside container

   plex:
     volumes:
       - /mnt/media:/media  # SAME /media path
   ```

   **Diagnosing:** Compare paths in Stash scene details vs Plex item details.

6. **Manual Queue Processing**
   For when the queue is stuck or large:

   ```bash
   # Check queue stats
   python process_queue.py --stats-only

   # Process queue manually
   python process_queue.py \
     --data-dir /path/to/PlexSync/data \
     --plex-url http://plex:32400 \
     --plex-token YOUR_TOKEN \
     --plex-library Adult
   ```

   Location: `process_queue.py` in PlexSync folder

7. **Understanding the Dead Letter Queue (DLQ)**
   - What: Storage for permanently failed jobs
   - When: Jobs that exceed max_retries OR have permanent errors
   - Location: `data/dlq.db` SQLite database
   - Retention: Cleaned up after 30 days (configurable)
   - Action: Review logs for error patterns, fix root cause, re-sync affected scenes

8. **Error Classification**
   Help users understand retry behavior:

   **Transient Errors** (will retry):
   - Network errors (connection refused, timeout)
   - Rate limiting (429)
   - Server errors (500, 502, 503, 504)
   - Not found (404) - retries in case Plex is still scanning

   **Permanent Errors** (goes to DLQ):
   - Auth failure (401)
   - Permission denied (403)
   - Bad request (400)
   - Validation errors
   - Low confidence match (strict mode)

9. **How to Report Issues**
   Template for GitHub issues:

   ```markdown
   **Environment:**
   - Stash version:
   - Plex version:
   - PlexSync version:
   - Deployment: Docker / Bare metal

   **Issue:**
   [Describe what happened]

   **Expected:**
   [What you expected to happen]

   **Logs:**
   [Paste relevant [PlexSync] log lines]

   **Steps to Reproduce:**
   1.
   2.
   3.
   ```

   Tips:
   - Filter logs to `[PlexSync]` lines
   - Include the full error message
   - Redact any tokens or personal info

10. **Related Documentation**
    - [Installation Guide](install.md)
    - [Configuration Reference](config.md)
  </action>
  <verify>
    - File exists: `test -f docs/troubleshoot.md && echo "EXISTS"`
    - Has common issues: `grep -q "## Common Issues" docs/troubleshoot.md && echo "HAS_ISSUES"`
    - Has log section: `grep -q "Reading the Logs" docs/troubleshoot.md && echo "HAS_LOGS"`
    - Has DLQ explanation: `grep -q "Dead Letter Queue" docs/troubleshoot.md && echo "HAS_DLQ"`
    - Has Docker section: `grep -q "Docker Path" docs/troubleshoot.md && echo "HAS_DOCKER"`
    - Has issue template: `grep -q "How to Report Issues" docs/troubleshoot.md && echo "HAS_TEMPLATE"`
    - Has 8 issues: `grep -c "Issue [0-9]:" docs/troubleshoot.md` (should be 8)
    - Links to config: `grep -q "config.md" docs/troubleshoot.md && echo "HAS_CONFIG_LINK"`
    - Line count: `wc -l docs/troubleshoot.md` (should be 200-350 lines)
  </verify>
  <done>
docs/troubleshoot.md exists with:
- Brief "how it works" context for troubleshooting
- Log interpretation guide with annotated examples
- All 8 common issues documented with symptoms, causes, solutions
- Docker path mapping section
- Manual queue processing instructions
- DLQ explanation at user level
- Issue reporting template
- Links to install.md and config.md
  </done>
</task>

</tasks>

<verification>
All checks pass:
- `test -f docs/troubleshoot.md` returns success
- `grep -q "## Common Issues" docs/troubleshoot.md` returns success
- `grep -c "Issue [0-9]:" docs/troubleshoot.md` returns 8
- `grep -q "Dead Letter Queue" docs/troubleshoot.md` returns success
- `grep -q "config.md" docs/troubleshoot.md` returns success
</verification>

<success_criteria>
- All 8 common issues from RESEARCH.md documented
- Log interpretation guide with real log examples
- Users understand queue/retry/DLQ at conceptual level
- Issue reporting template helps users provide useful bug reports
- Cross-links to config.md for related settings
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-documentation/04-04-SUMMARY.md`
</output>
