---
phase: 05-architecture-documentation
plan: 01
title: Architecture Documentation
status: pending
created: 2026-02-03
type: execute
wave: 1
depends_on: []
files_modified: [docs/ARCHITECTURE.md]
autonomous: true

must_haves:
  truths:
    - "New contributor can identify all 5 modules and their responsibilities"
    - "Data flow from Stash hook to Plex update is traceable through diagram"
    - "Design decisions explain WHY, not just WHAT"
  artifacts:
    - path: "docs/ARCHITECTURE.md"
      provides: "Developer architecture documentation"
      contains: ["mermaid", "hooks/", "sync_queue/", "worker/", "plex/", "validation/"]
      min_lines: 150
  key_links:
    - from: "docs/ARCHITECTURE.md"
      to: "source modules"
      via: "file path references in module descriptions"
---

# Plan 05-01: Architecture Documentation

## Objective

Create `docs/ARCHITECTURE.md` - a high-level developer guide explaining PlexSync's internal architecture. Covers the 5 core modules, data flow through the system, and design rationale for key architectural decisions.

**Purpose:** Enable new contributors to understand the codebase structure quickly without reading all source files.

**Output:** Single markdown file with Mermaid diagram, module descriptions, and design decision explanations.

## Deliverables

- [ ] `docs/ARCHITECTURE.md` (150-250 lines)

## Tasks

### Task 1: Create Architecture Document Structure

<task type="auto">
  <name>Create docs/ARCHITECTURE.md with full architecture content</name>
  <files>docs/ARCHITECTURE.md</files>
  <action>
Create `docs/ARCHITECTURE.md` with the following sections:

**1. Overview (10-15 lines)**
- Brief description: Stash plugin syncing metadata to Plex
- Producer-consumer pattern with persistent queue
- Link to external docs (Stash plugin system, plexapi)

**2. System Diagram (Mermaid, ~50 lines)**
Use the diagram from 05-RESEARCH.md as starting point. Must show:
- External systems: Stash Server, Plex Server
- PlexSync subgraphs: hooks/, sync_queue/, worker/, plex/, validation/
- Key data stores: SQLite Queue, DLQ, sync_timestamps.json
- Data flow arrows with labels (e.g., "Scene.Update.Post", "enqueue", "get_pending")

**3. Module Overview (60-80 lines)**
For each of the 5 modules, include:
- **Purpose:** One sentence on what it does
- **Key files:** List main files (e.g., `handlers.py`, `processor.py`)
- **Responsibilities:** 2-3 bullet points
- **Design note:** Brief rationale inline (e.g., "Target <100ms to avoid hook timeouts")

Modules to cover:
1. `hooks/` - Event capture layer
2. `sync_queue/` - Persistence layer (SQLiteAckQueue, DLQ)
3. `worker/` - Processing layer (retry, circuit breaker)
4. `plex/` - API client layer (matching, error translation)
5. `validation/` - Data quality layer (Pydantic models)

**4. Data Flow (30-40 lines)**
Describe the 7-step flow from 05-RESEARCH.md in prose, not ASCII diagrams:
1. Event capture (Stash hook fires)
2. Filtering (scan check, sync check, pending check)
3. Validation and enqueue
4. Worker dequeue and circuit breaker check
5. Plex matching (fast path, slow fallback)
6. Metadata update
7. Job completion (ack/nack/fail)

**5. Design Decisions (40-50 lines)**
Cover these 4 decisions with Problem/Decision/Why format:
1. SQLite queue for crash recovery
2. Circuit breaker for Plex outages
3. Exponential backoff with full jitter
4. Confidence-based matching

**6. External Resources (10 lines)**
Links to:
- Stash plugin docs
- plexapi documentation
- persist-queue, tenacity, pydantic docs

**Style guidelines:**
- No code examples (reference source files instead)
- Assume advanced Python knowledge
- High-level concepts, not implementation details
- ~200 lines total target
  </action>
  <verify>
- File exists at docs/ARCHITECTURE.md
- Contains Mermaid diagram (```mermaid block present)
- All 5 modules documented (hooks, sync_queue, worker, plex, validation)
- Design decisions section present
- Word count 800-1500 words
  </verify>
  <done>
docs/ARCHITECTURE.md exists with:
- Mermaid system diagram rendering in GitHub
- Module overview for all 5 core modules
- Data flow explanation (7 steps)
- 4 design decision explanations
- External resource links
  </done>
</task>

### Task 2: Verify Document Renders Correctly

<task type="auto">
  <name>Validate Mermaid syntax and markdown structure</name>
  <files>docs/ARCHITECTURE.md</files>
  <action>
Verify the created document:

1. Check Mermaid syntax is valid:
   - Diagram starts with ```mermaid and ends with ```
   - Uses supported Mermaid graph syntax (graph TB, subgraph, arrows)
   - No invalid characters or broken links

2. Check markdown structure:
   - All headers use proper hierarchy (# > ## > ###)
   - No broken links
   - Consistent formatting

3. Check content completeness:
   - All 5 modules mentioned by name
   - Design decisions cover the 4 key patterns
   - External links are valid URLs

4. Verify line count is in range (150-250 lines)
  </action>
  <verify>
Run: `wc -l docs/ARCHITECTURE.md` (should be 150-250)
Run: `grep -c "^##" docs/ARCHITECTURE.md` (should be 5-7 sections)
Run: `grep -c "mermaid" docs/ARCHITECTURE.md` (should be at least 1)
  </verify>
  <done>
Document passes all validation checks:
- Line count within range
- Proper section structure
- Valid Mermaid block
  </done>
</task>

## must_haves

- [ ] docs/ARCHITECTURE.md exists (150-250 lines)
- [ ] Mermaid diagram shows all 5 modules and external systems
- [ ] Each module has Purpose, Key files, Responsibilities, Design note
- [ ] Data flow describes complete path from Stash event to Plex update
- [ ] 4 design decisions documented with Problem/Decision/Why
- [ ] External resource links included

## Dependencies

None - this plan can run independently.

## Verification

```bash
# File exists and has content
test -f docs/ARCHITECTURE.md && echo "PASS: File exists"

# Check line count (150-250 target)
lines=$(wc -l < docs/ARCHITECTURE.md)
[ "$lines" -ge 150 ] && [ "$lines" -le 300 ] && echo "PASS: Line count $lines"

# Check Mermaid diagram present
grep -q '```mermaid' docs/ARCHITECTURE.md && echo "PASS: Mermaid diagram found"

# Check all modules documented
for mod in hooks sync_queue worker plex validation; do
  grep -q "$mod/" docs/ARCHITECTURE.md && echo "PASS: $mod documented"
done

# Check design decisions section
grep -q "Design Decisions" docs/ARCHITECTURE.md && echo "PASS: Design decisions section"
```

## Success Criteria

- New contributor can read ARCHITECTURE.md and understand:
  - What each module does (without reading source)
  - How data flows through the system
  - Why key architectural decisions were made
- Mermaid diagram renders correctly on GitHub
- Document is concise (~200 lines, not a novel)
