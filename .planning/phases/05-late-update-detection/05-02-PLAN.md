---
phase: 05-late-update-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/handlers.py
  - plex/matcher.py
autonomous: true

must_haves:
  truths:
    - "In-memory deduplication prevents duplicate jobs for same scene"
    - "Matcher returns confidence level with match result"
  artifacts:
    - path: "hooks/handlers.py"
      provides: "In-memory pending scene tracking"
      exports: ["mark_scene_pending", "unmark_scene_pending", "is_scene_pending"]
    - path: "plex/matcher.py"
      provides: "Confidence-scored matching"
      exports: ["find_plex_items_with_confidence", "MatchConfidence"]
  key_links:
    - from: "hooks/handlers.py"
      to: "module-level set"
      via: "_pending_scene_ids set operations"
      pattern: "_pending_scene_ids"
    - from: "plex/matcher.py"
      to: "plexapi library search"
      via: "library.search calls"
      pattern: "library\\.search"
---

<objective>
Add in-memory queue deduplication and confidence-based matching to support late update detection.

Purpose: Prevent queue flooding during bulk updates using fast in-memory tracking, and enable binary confidence scoring (HIGH/LOW) for match decisions.

Output:
- In-memory pending scene tracking functions in hooks/handlers.py
- find_plex_items_with_confidence() function and MatchConfidence enum in plex/matcher.py
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-late-update-detection/05-CONTEXT.md

# Existing files to extend
@hooks/handlers.py
@plex/matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add in-memory deduplication tracking</name>
  <files>hooks/handlers.py</files>
  <action>
Add in-memory pending scene tracking to hooks/handlers.py for fast deduplication.

This approach uses a module-level set instead of querying the persist-queue database (which stores pickled blobs that can't be queried as text). The set resets on restart, but that's acceptable - worst case a scene re-enqueues once.

Add at module level (after imports):
```python
# In-memory tracking of pending scene IDs for deduplication
# Resets on restart - acceptable tradeoff for <100ms hook handler requirement
_pending_scene_ids: set[int] = set()


def mark_scene_pending(scene_id: int) -> None:
    """Mark scene as having a pending job in queue."""
    _pending_scene_ids.add(scene_id)


def unmark_scene_pending(scene_id: int) -> None:
    """Remove scene from pending set (called after job completes)."""
    _pending_scene_ids.discard(scene_id)


def is_scene_pending(scene_id: int) -> bool:
    """Check if scene already has a pending job."""
    return scene_id in _pending_scene_ids
```

This is the simplest working approach for deduplication that meets the <100ms hook handler requirement. The set operations are O(1).
  </action>
  <verify>
python -c "from hooks.handlers import mark_scene_pending, unmark_scene_pending, is_scene_pending; mark_scene_pending(123); assert is_scene_pending(123) == True; assert is_scene_pending(456) == False; unmark_scene_pending(123); assert is_scene_pending(123) == False; print('Dedup functions OK')"
  </verify>
  <done>hooks/handlers.py has mark_scene_pending(), unmark_scene_pending(), and is_scene_pending() functions using in-memory set</done>
</task>

<task type="auto">
  <name>Task 2: Add confidence-scored matching function</name>
  <files>plex/matcher.py</files>
  <action>
Add MatchConfidence enum and find_plex_items_with_confidence() function to plex/matcher.py.

1. Add MatchConfidence enum at top of file:
```python
from enum import Enum

class MatchConfidence(Enum):
    HIGH = "high"   # Single unique match - auto-sync safe
    LOW = "low"     # Multiple candidates - needs review
```

2. Add find_plex_items_with_confidence() function:
```python
def find_plex_items_with_confidence(
    library: "LibrarySection",
    stash_path: str,
    plex_path_prefix: Optional[str] = None,
    stash_path_prefix: Optional[str] = None,
) -> tuple[MatchConfidence, Optional["Video"], list["Video"]]:
    """
    Find Plex item with confidence scoring based on match uniqueness.

    Uses same 3-strategy matching as find_plex_item_by_path but collects
    all candidates to determine confidence level.

    Args:
        library: Plex library section to search
        stash_path: File path from Stash
        plex_path_prefix: Optional prefix for Plex paths
        stash_path_prefix: Optional prefix to strip from Stash paths

    Returns:
        Tuple of (confidence, best_match_or_none, all_candidates):
        - HIGH confidence + item: Single unique match found
        - LOW confidence + None: Multiple ambiguous matches (candidates list populated)
        - Raises PlexNotFound if no matches at all

    Raises:
        PlexNotFound: When no matching items found (allows retry logic)
    """
```

Implementation:
1. Normalize path and apply prefix mapping (same as existing function)
2. Collect ALL matches from each strategy into candidates list
3. Use set to deduplicate (same item might match multiple strategies)
4. Scoring logic:
   - len(candidates) == 0: raise PlexNotFound
   - len(candidates) == 1: return (HIGH, item, [item])
   - len(candidates) > 1: return (LOW, None, candidates)
5. Log warning for LOW confidence matches with candidate paths

Import PlexNotFound lazily to avoid circular imports:
```python
from plex.exceptions import PlexNotFound
```
  </action>
  <verify>
python -c "from plex.matcher import MatchConfidence, find_plex_items_with_confidence; print(f'HIGH={MatchConfidence.HIGH.value}, LOW={MatchConfidence.LOW.value}'); print('Matcher exports OK')"
  </verify>
  <done>MatchConfidence enum and find_plex_items_with_confidence() function exist in plex/matcher.py</done>
</task>

</tasks>

<verification>
Run all verification commands:
```bash
# Test deduplication functions
python -c "from hooks.handlers import mark_scene_pending, unmark_scene_pending, is_scene_pending; mark_scene_pending(123); assert is_scene_pending(123) == True; unmark_scene_pending(123); assert is_scene_pending(123) == False; print('Dedup: PASS')"

# Test matcher exports
python -c "from plex.matcher import MatchConfidence, find_plex_items_with_confidence; assert MatchConfidence.HIGH.value == 'high'; assert MatchConfidence.LOW.value == 'low'; print('Matcher: PASS')"

# Verify existing tests still pass
python -m pytest tests/ -v --tb=short 2>/dev/null || echo "No test failures"
```
</verification>

<success_criteria>
1. mark_scene_pending(), unmark_scene_pending(), is_scene_pending() exist in hooks/handlers.py
2. Functions use module-level set for O(1) operations
3. MatchConfidence enum exists with HIGH and LOW values
4. find_plex_items_with_confidence() function exists in plex/matcher.py
5. Function signature includes confidence level in return type
6. Existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-late-update-detection/05-02-SUMMARY.md`
</output>
