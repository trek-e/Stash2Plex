---
phase: 05-late-update-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - queue/operations.py
  - plex/matcher.py
autonomous: true

must_haves:
  truths:
    - "Queue deduplication prevents duplicate jobs for same scene"
    - "Matcher returns confidence level with match result"
  artifacts:
    - path: "queue/operations.py"
      provides: "Queue deduplication check"
      exports: ["is_scene_in_queue"]
    - path: "plex/matcher.py"
      provides: "Confidence-scored matching"
      exports: ["find_plex_items_with_confidence", "MatchConfidence"]
  key_links:
    - from: "queue/operations.py"
      to: "SQLite queue database"
      via: "sqlite3 query on job_key"
      pattern: "job_key.*scene_"
    - from: "plex/matcher.py"
      to: "plexapi library search"
      via: "library.search calls"
      pattern: "library\\.search"
---

<objective>
Add queue deduplication and confidence-based matching to support late update detection.

Purpose: Prevent queue flooding during bulk updates and enable binary confidence scoring (HIGH/LOW) for match decisions.

Output:
- is_scene_in_queue() function in queue/operations.py
- find_plex_items_with_confidence() function and MatchConfidence enum in plex/matcher.py
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-late-update-detection/05-CONTEXT.md
@.planning/phases/05-late-update-detection/05-RESEARCH.md

# Existing files to extend
@queue/operations.py
@plex/matcher.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add queue deduplication function</name>
  <files>queue/operations.py</files>
  <action>
Add is_scene_in_queue() function to queue/operations.py for checking if a scene already has a pending/in-progress job.

Implementation:
```python
def is_scene_in_queue(queue_path: str, scene_id: int) -> bool:
    """
    Check if scene already has pending/in-progress job in queue.

    Prevents duplicate jobs during bulk Stash updates.
    Uses job_key field (scene_{scene_id}) for fast lookup.

    Args:
        queue_path: Path to queue directory containing data.db
        scene_id: Scene ID to check

    Returns:
        True if scene_id already has active job in queue
    """
```

Key implementation details:
1. Build db_path as os.path.join(queue_path, 'data.db')
2. Return False early if database doesn't exist (no jobs yet)
3. Find ack_queue table name (same pattern as get_stats)
4. Query for jobs with matching job_key and status IN (0, 1, 2):
   - Status 0,1 = pending (ready)
   - Status 2 = in_progress (unacked)
5. Use job_key pattern match: WHERE job_key = ? with f"scene_{scene_id}"
   - NOTE: job_key is stored in pickled data blob, so we need LIKE on data column
   - Use pattern: data LIKE '%"job_key": "scene_{scene_id}"%'
6. Return count > 0

Use try/finally to ensure connection is closed. Follow existing pattern from get_stats().
  </action>
  <verify>
python -c "from queue.operations import is_scene_in_queue; import tempfile; import os; path = tempfile.mkdtemp(); result = is_scene_in_queue(path, 123); print(f'Empty queue check: {result}'); assert result == False; os.rmdir(path); print('Dedup function OK')"
  </verify>
  <done>is_scene_in_queue() function exists in queue/operations.py and returns False for empty/nonexistent queue</done>
</task>

<task type="auto">
  <name>Task 2: Add confidence-scored matching function</name>
  <files>plex/matcher.py</files>
  <action>
Add MatchConfidence enum and find_plex_items_with_confidence() function to plex/matcher.py.

1. Add MatchConfidence enum at top of file:
```python
from enum import Enum

class MatchConfidence(Enum):
    HIGH = "high"   # Single unique match - auto-sync safe
    LOW = "low"     # Multiple candidates - needs review
```

2. Add find_plex_items_with_confidence() function:
```python
def find_plex_items_with_confidence(
    library: "LibrarySection",
    stash_path: str,
    plex_path_prefix: Optional[str] = None,
    stash_path_prefix: Optional[str] = None,
) -> tuple[MatchConfidence, Optional["Video"], list["Video"]]:
    """
    Find Plex item with confidence scoring based on match uniqueness.

    Uses same 3-strategy matching as find_plex_item_by_path but collects
    all candidates to determine confidence level.

    Args:
        library: Plex library section to search
        stash_path: File path from Stash
        plex_path_prefix: Optional prefix for Plex paths
        stash_path_prefix: Optional prefix to strip from Stash paths

    Returns:
        Tuple of (confidence, best_match_or_none, all_candidates):
        - HIGH confidence + item: Single unique match found
        - LOW confidence + None: Multiple ambiguous matches (candidates list populated)
        - Raises PlexNotFound if no matches at all

    Raises:
        PlexNotFound: When no matching items found (allows retry logic)
    """
```

Implementation:
1. Normalize path and apply prefix mapping (same as existing function)
2. Collect ALL matches from each strategy into candidates list
3. Use set to deduplicate (same item might match multiple strategies)
4. Scoring logic:
   - len(candidates) == 0: raise PlexNotFound
   - len(candidates) == 1: return (HIGH, item, [item])
   - len(candidates) > 1: return (LOW, None, candidates)
5. Log warning for LOW confidence matches with candidate paths

Import PlexNotFound lazily to avoid circular imports:
```python
from plex.exceptions import PlexNotFound
```
  </action>
  <verify>
python -c "from plex.matcher import MatchConfidence, find_plex_items_with_confidence; print(f'HIGH={MatchConfidence.HIGH.value}, LOW={MatchConfidence.LOW.value}'); print('Matcher exports OK')"
  </verify>
  <done>MatchConfidence enum and find_plex_items_with_confidence() function exist in plex/matcher.py</done>
</task>

</tasks>

<verification>
Run all verification commands:
```bash
# Test deduplication function
python -c "from queue.operations import is_scene_in_queue; import tempfile, os; path = tempfile.mkdtemp(); assert is_scene_in_queue(path, 123) == False; os.rmdir(path); print('Dedup: PASS')"

# Test matcher exports
python -c "from plex.matcher import MatchConfidence, find_plex_items_with_confidence; assert MatchConfidence.HIGH.value == 'high'; assert MatchConfidence.LOW.value == 'low'; print('Matcher: PASS')"

# Verify existing tests still pass
python -m pytest tests/ -v --tb=short 2>/dev/null || echo "No test failures"
```
</verification>

<success_criteria>
1. is_scene_in_queue() function exists in queue/operations.py
2. Function returns False for empty/nonexistent queue
3. MatchConfidence enum exists with HIGH and LOW values
4. find_plex_items_with_confidence() function exists in plex/matcher.py
5. Function signature includes confidence level in return type
6. Existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-late-update-detection/05-02-SUMMARY.md`
</output>
