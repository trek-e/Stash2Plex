---
phase: 18-health-check-infrastructure
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - plex/health.py
  - tests/plex/test_health.py
autonomous: true

must_haves:
  truths:
    - "check_plex_health() returns (True, latency_ms) when server responds to /identity"
    - "check_plex_health() returns (False, 0.0) when server is unreachable"
    - "check_plex_health() uses short timeout (5s default) to avoid blocking worker thread"
    - "Health check validates database access via /identity endpoint (not just TCP/HTTP)"
  artifacts:
    - path: "plex/health.py"
      provides: "Deep health check function using server.query('/identity')"
      exports: ["check_plex_health"]
    - path: "tests/plex/test_health.py"
      provides: "Tests for health check success, failure, timeout, and edge cases"
      min_lines: 60
  key_links:
    - from: "plex/health.py"
      to: "plex/client.py"
      via: "PlexClient.server.query('/identity')"
      pattern: "server\\.query.*identity"
---

<objective>
Create the core health check function that validates Plex server connectivity via the /identity endpoint.

Purpose: The /identity endpoint requires database access, preventing false positives during Plex's multi-stage startup sequence (port open -> HTTP responding -> database loading -> API ready). This is the foundation that both the manual health check task and worker loop integration depend on.

Output: `plex/health.py` with `check_plex_health()` function and comprehensive test suite.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@plex/client.py
@plex/exceptions.py
@shared/log.py
@tests/plex/test_client.py
</context>

<feature>
  <name>Deep Plex Health Check</name>
  <files>plex/health.py, tests/plex/test_health.py</files>
  <behavior>
    check_plex_health(plex_client, timeout=5.0) -> Tuple[bool, float]

    Cases:
    - Server responds to /identity within timeout -> (True, latency_ms) where latency_ms > 0
    - Server unreachable (ConnectionError) -> (False, 0.0)
    - Server times out -> (False, 0.0)
    - Server returns 503 (database loading) -> (False, 0.0)
    - Any exception from server.query -> (False, 0.0)
    - Custom timeout parameter is passed through to server.query
    - Default timeout is 5.0 seconds (not 30s like normal operations)

    Implementation notes:
    - Use plexapi's server.query('/identity', timeout=timeout) for raw API access
    - /identity is lightweight (~200 bytes XML), requires DB access, no auth needed
    - Measure latency with time.perf_counter() for precision
    - Log failures at debug level (not warning) since health check failures during outages are expected
    - Use shared.log create_logger("Health") for logging, following project convention
    - Import PlexClient type from plex.client for type hints (TYPE_CHECKING import)
    - Catch broad Exception (not specific types) since any failure means "not healthy"
    - Decision v1.3: Debug logs use log_info with prefix since Stash filters out log_debug entirely.
      For health check failures during normal OPEN circuit operation, use log_debug (these are expected
      and would be noisy at info level). The caller (worker loop, manual task) logs at appropriate levels.
  </behavior>
  <implementation>
    Create plex/health.py as a small, focused module:
    - Module docstring explaining deep health check pattern
    - Single function check_plex_health() with type annotations
    - Tuple return type from typing import
    - Use time.perf_counter() for latency measurement
    - Catch Exception broadly, log at debug level, return (False, 0.0)
    - Include __all__ export list
  </implementation>
</feature>

<verification>
```bash
cd /Users/trekkie/projects/PlexSync && python -m pytest tests/plex/test_health.py -v
cd /Users/trekkie/projects/PlexSync && python -m pytest tests/ -x --timeout=60
```
</verification>

<success_criteria>
- plex/health.py exists with check_plex_health() function
- All test cases pass: success, connection error, timeout, 503, custom timeout
- Function signature: check_plex_health(plex_client, timeout=5.0) -> Tuple[bool, float]
- server.query('/identity') is called (not TCP connect or HTTP GET /)
- Existing test suite passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/18-health-check-infrastructure/18-01-SUMMARY.md`
</output>
