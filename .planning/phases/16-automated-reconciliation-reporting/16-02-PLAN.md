---
phase: 16-automated-reconciliation-reporting
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - tests/reconciliation/test_scheduler.py
  - tests/reconciliation/test_auto_reconcile.py
autonomous: true

must_haves:
  truths:
    - "Scheduler correctly determines when reconciliation is due based on interval"
    - "Startup detection works (never run = due, recent run = not due)"
    - "State persistence round-trips correctly (save and load)"
    - "Auto-reconciliation integration works with mocked engine"
    - "Enhanced queue status displays reconciliation info"
    - "Config validates reconcile_interval and reconcile_scope correctly"
  artifacts:
    - path: "tests/reconciliation/test_scheduler.py"
      provides: "Unit tests for ReconciliationScheduler"
      min_lines: 100
    - path: "tests/reconciliation/test_auto_reconcile.py"
      provides: "Integration tests for auto-reconciliation wiring"
      min_lines: 80
  key_links:
    - from: "tests/reconciliation/test_scheduler.py"
      to: "reconciliation/scheduler.py"
      via: "import and instantiate ReconciliationScheduler"
      pattern: "from reconciliation.scheduler import"
    - from: "tests/reconciliation/test_auto_reconcile.py"
      to: "Stash2Plex.py"
      via: "import and test maybe_auto_reconcile, handle_queue_status"
      pattern: "maybe_auto_reconcile|handle_queue_status"
---

<objective>
Comprehensive test coverage for automated reconciliation scheduling, state persistence, and enhanced queue status.

Purpose: Ensure the auto-reconciliation scheduler, config validation, state persistence, and enhanced queue status reporting all work correctly and handle edge cases.

Output: Two test files covering scheduler unit tests and auto-reconciliation integration tests, maintaining 80%+ coverage.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-automated-reconciliation-reporting/16-01-SUMMARY.md
@reconciliation/scheduler.py
@reconciliation/engine.py
@validation/config.py
@Stash2Plex.py
@tests/reconciliation/test_reconcile_task.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scheduler unit tests</name>
  <files>tests/reconciliation/test_scheduler.py</files>
  <action>
Create comprehensive unit tests for `ReconciliationScheduler` in `tests/reconciliation/test_scheduler.py`. Follow the existing test patterns in `tests/reconciliation/test_reconcile_task.py` (use `unittest.mock`, `tmp_path` fixture, no external dependencies).

**Test cases to cover:**

**ReconciliationState defaults:**
1. `test_default_state` -- Fresh ReconciliationState has last_run_time=0.0, run_count=0, empty gaps_by_type

**State persistence:**
2. `test_load_state_no_file` -- load_state() returns defaults when no file exists
3. `test_save_and_load_state` -- Save state, load it back, verify all fields match
4. `test_load_state_corrupt_json` -- Corrupt JSON file returns defaults (graceful degradation)
5. `test_save_state_atomic` -- State file is written atomically (tmp then rename)

**is_due() logic:**
6. `test_is_due_never` -- interval='never' always returns False
7. `test_is_due_hourly_not_elapsed` -- 30 min since last run, hourly interval -> False
8. `test_is_due_hourly_elapsed` -- 61 min since last run, hourly interval -> True
9. `test_is_due_daily_elapsed` -- 25 hours since last run, daily interval -> True
10. `test_is_due_weekly_not_elapsed` -- 3 days since last run, weekly interval -> False
11. `test_is_due_first_run` -- No previous run (last_run_time=0.0), any interval -> True

**is_startup_due() logic:**
12. `test_startup_due_never_run` -- No previous run -> True
13. `test_startup_due_recent_run` -- Ran 30 min ago -> False (avoid rapid restart spam)
14. `test_startup_due_old_run` -- Ran 2 hours ago -> True

**record_run():**
15. `test_record_run_basic` -- Record a run, verify all fields populated including gaps_by_type
16. `test_record_run_increments_count` -- Multiple records increment run_count
17. `test_record_run_startup_flag` -- is_startup flag is stored correctly

**Config validation:**
18. `test_config_reconcile_interval_valid` -- All valid values accepted (never, hourly, daily, weekly)
19. `test_config_reconcile_interval_invalid` -- Invalid value raises ValidationError
20. `test_config_reconcile_interval_default` -- Default is 'never'
21. `test_config_reconcile_scope_valid` -- All valid values accepted (all, 24h, 7days)
22. `test_config_reconcile_scope_invalid` -- Invalid value raises ValidationError
23. `test_config_reconcile_scope_default` -- Default is '24h'

**Implementation notes:**
- Use `tmp_path` fixture for all file operations
- Use explicit `now` parameter for time-dependent tests (no freezegun needed)
- For config tests, import `Stash2PlexConfig` and `ValidationError` from `validation.config`
- Mock GapDetectionResult with a simple dataclass or Mock for `record_run()` tests
  </action>
  <verify>
```bash
python3 -m pytest tests/reconciliation/test_scheduler.py -v
```
All tests pass.
  </verify>
  <done>
- 20+ tests covering scheduler state persistence, is_due() logic, is_startup_due() logic, record_run(), and config validation
- All tests pass
- No external dependencies (uses tmp_path, unittest.mock)
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-reconciliation integration tests</name>
  <files>tests/reconciliation/test_auto_reconcile.py</files>
  <action>
Create integration tests for the auto-reconciliation wiring in `tests/reconciliation/test_auto_reconcile.py`. These test the functions in Stash2Plex.py that connect the scheduler to the engine.

**Test cases to cover:**

**maybe_auto_reconcile():**
1. `test_auto_reconcile_disabled_when_never` -- config.reconcile_interval='never' -> no engine call
2. `test_auto_reconcile_disabled_when_no_config` -- config=None -> returns without error
3. `test_auto_reconcile_disabled_when_no_stash` -- stash_interface=None -> returns without error
4. `test_auto_reconcile_startup_trigger` -- First run triggers startup reconciliation (recent scope)
5. `test_auto_reconcile_interval_trigger` -- Interval elapsed triggers reconciliation with configured scope
6. `test_auto_reconcile_not_due` -- Neither startup nor interval due -> no engine call
7. `test_auto_reconcile_exception_handling` -- Engine error is caught and logged, not raised

**_run_auto_reconcile():**
8. `test_run_auto_reconcile_records_state` -- After successful run, scheduler state is updated
9. `test_run_auto_reconcile_engine_error` -- Engine exception is caught and logged

**handle_queue_status() enhanced output:**
10. `test_queue_status_shows_reconciliation_info` -- When state exists, reconciliation info is logged
11. `test_queue_status_no_reconciliation_runs` -- When no state, shows "No reconciliation runs yet"

**Scope mapping:**
12. `test_reconcile_7days_mode_dispatch` -- mode='reconcile_7days' calls handle_reconcile('recent_7days')

**Implementation notes:**
- Mock globals (config, stash_interface, queue_manager) using `unittest.mock.patch`
- Mock `ReconciliationScheduler` to control is_due/is_startup_due return values
- Mock `GapDetectionEngine` to verify it's called with correct args
- Follow the exact pattern in `tests/reconciliation/test_reconcile_task.py` for mocking Stash2Plex.py globals
- Use `capsys` or mock `print` to verify log output for queue status tests
  </action>
  <verify>
```bash
python3 -m pytest tests/reconciliation/test_auto_reconcile.py -v
python3 -m pytest tests/reconciliation/ -v
python3 -m pytest --cov --cov-fail-under=80
```
All tests pass, 80%+ coverage maintained.
  </verify>
  <done>
- 12+ integration tests covering maybe_auto_reconcile(), _run_auto_reconcile(), enhanced queue status, and scope mapping
- All reconciliation tests pass (60+ total across 4 test files)
- Full suite passes with 80%+ coverage
  </done>
</task>

</tasks>

<verification>
1. All scheduler tests pass:
```bash
python3 -m pytest tests/reconciliation/test_scheduler.py -v
```

2. All auto-reconcile integration tests pass:
```bash
python3 -m pytest tests/reconciliation/test_auto_reconcile.py -v
```

3. All reconciliation tests pass together:
```bash
python3 -m pytest tests/reconciliation/ -v
```

4. Full test suite with coverage:
```bash
python3 -m pytest --cov --cov-fail-under=80
```
</verification>

<success_criteria>
- 30+ new tests across two test files
- All scheduler edge cases covered (intervals, startup, persistence, corruption)
- All auto-reconciliation integration paths covered (disabled, startup, interval, errors)
- Enhanced queue status output verified
- Full test suite passes with 80%+ coverage
</success_criteria>

<output>
After completion, create `.planning/phases/16-automated-reconciliation-reporting/16-02-SUMMARY.md`
</output>
