---
phase: 01-testing-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/conftest.py
  - tests/plex/__init__.py
  - tests/sync_queue/__init__.py
  - tests/worker/__init__.py
  - tests/validation/__init__.py
  - tests/hooks/__init__.py
autonomous: true

must_haves:
  truths:
    - "Test fixtures for mocking PlexServer are available via conftest.py"
    - "Test fixtures for mocking configuration are available"
    - "Test fixtures for mocking queue operations are available"
    - "Test directory structure mirrors source layout"
  artifacts:
    - path: "tests/conftest.py"
      provides: "shared pytest fixtures"
      contains: "mock_plex_server"
      min_lines: 100
    - path: "tests/plex/__init__.py"
      provides: "test package for plex module"
    - path: "tests/sync_queue/__init__.py"
      provides: "test package for sync_queue module"
    - path: "tests/worker/__init__.py"
      provides: "test package for worker module"
    - path: "tests/validation/__init__.py"
      provides: "test package for validation module"
  key_links:
    - from: "tests/conftest.py"
      to: "unittest.mock"
      via: "Mock/MagicMock imports"
      pattern: "from unittest.mock import"
    - from: "tests/conftest.py"
      to: "@pytest.fixture"
      via: "fixture decorators"
      pattern: "@pytest.fixture"
---

<objective>
Create pytest fixtures and test directory structure for PlexSync.

Purpose: Provide reusable mock fixtures for PlexServer, StashInterface, configuration, and queue operations that all tests can use. Establish directory structure that mirrors source layout for organized test placement.

Output: tests/conftest.py with mock fixtures, test subdirectories with __init__.py files
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Source modules to mirror in tests
@plex/client.py
@sync_queue/manager.py
@worker/circuit_breaker.py
@validation/metadata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test directory structure mirroring source</name>
  <files>
tests/plex/__init__.py
tests/sync_queue/__init__.py
tests/worker/__init__.py
tests/validation/__init__.py
tests/hooks/__init__.py
  </files>
  <action>
Create subdirectories in tests/ that mirror the source layout:
- tests/plex/ - for plex client, matcher, exceptions tests
- tests/sync_queue/ - for queue manager, operations, DLQ tests
- tests/worker/ - for processor, backoff, circuit breaker tests
- tests/validation/ - for metadata, config validation tests
- tests/hooks/ - for event handler tests

Each directory needs an empty __init__.py file for pytest to discover tests.

Do NOT move existing test files yet - leave test_backoff.py, test_circuit_breaker.py, etc. in tests/ root. Moving them is Phase 2 work (Core Unit Tests).
  </action>
  <verify>ls -la tests/plex tests/sync_queue tests/worker tests/validation tests/hooks shows __init__.py in each</verify>
  <done>All 5 test subdirectories exist with __init__.py files</done>
</task>

<task type="auto">
  <name>Task 2: Create conftest.py with mock fixtures</name>
  <files>tests/conftest.py</files>
  <action>
Create tests/conftest.py with fixtures based on RESEARCH.md patterns:

**Plex API Mocks:**
- mock_plex_server: MagicMock with friendlyName, version, library.sections()
- mock_plex_section: MagicMock with title, type, search() returning empty list
- mock_plex_item: MagicMock with title, studio, summary, actors, genres, collections, media[0].parts[0].file path

**Configuration Mocks:**
- mock_config: Mock with all PlexSyncConfig attributes (plex_url, plex_token, plex_library, poll_interval, max_retries, etc.)
- valid_config_dict: Dict for PlexSyncConfig instantiation

**Queue Mocks:**
- mock_queue: MagicMock for SQLiteAckQueue with put(), get(), ack(), nack()
- mock_dlq: MagicMock for DeadLetterQueue with add(), get_count(), get_recent()

**Test Data Fixtures:**
- sample_job: Dict with scene_id, update_type, data (path, title, studio, details)
- sample_metadata_dict: Valid dict for SyncMetadata model

Use function scope (default) for all fixtures - they're mutable.
Include docstrings explaining what each fixture provides.

Import pattern:
```python
import pytest
from unittest.mock import Mock, MagicMock
```

Do NOT import plexapi, stashapi, or any external libraries in conftest.py - that would cause import failures when those aren't installed.
  </action>
  <verify>grep -c "@pytest.fixture" tests/conftest.py returns at least 8</verify>
  <done>conftest.py has mock_plex_server, mock_plex_section, mock_plex_item, mock_config, valid_config_dict, mock_queue, mock_dlq, sample_job, sample_metadata_dict fixtures</done>
</task>

</tasks>

<verification>
Run these commands to verify plan completion:
1. `ls tests/*/` - verify all subdirectories exist
2. `cat tests/plex/__init__.py tests/sync_queue/__init__.py` - verify __init__.py files exist
3. `grep "@pytest.fixture" tests/conftest.py | wc -l` - should be 8+
4. `python -c "from tests.conftest import *"` - verify conftest.py is valid Python (may fail on pytest imports without pytest installed)
5. `pytest --collect-only` - verify test discovery still works with new structure
</verification>

<success_criteria>
- tests/plex/, tests/sync_queue/, tests/worker/, tests/validation/, tests/hooks/ directories exist with __init__.py
- tests/conftest.py has at least 8 fixtures (Plex, config, queue, test data)
- Existing tests still discovered by pytest
- No import-time errors in conftest.py
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-02-SUMMARY.md`
</output>
