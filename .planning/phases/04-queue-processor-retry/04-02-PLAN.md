---
phase: 04-queue-processor-retry
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - worker/circuit_breaker.py
  - validation/config.py
  - tests/test_circuit_breaker.py
autonomous: true

must_haves:
  truths:
    - "Circuit breaker blocks execution after 5 consecutive failures"
    - "Circuit breaker allows test request after recovery timeout"
    - "Successful request in HALF_OPEN state closes circuit"
    - "DLQ retention period is configurable via PlexSyncConfig"
  artifacts:
    - path: "worker/circuit_breaker.py"
      provides: "Circuit breaker state machine"
      exports: ["CircuitBreaker", "CircuitState"]
    - path: "validation/config.py"
      provides: "Config with dlq_retention_days"
      contains: "dlq_retention_days"
    - path: "tests/test_circuit_breaker.py"
      provides: "Unit tests for circuit breaker"
      min_lines: 50
  key_links:
    - from: "worker/circuit_breaker.py"
      to: "time.time"
      via: "timestamp comparison for recovery"
      pattern: "time\\.time\\(\\)"
---

<objective>
Implement circuit breaker state machine and add DLQ retention config.

Purpose: Circuit breaker pauses job processing when Plex is down, preventing retry exhaustion during outages. DLQ retention config allows users to control cleanup period.

Output: `worker/circuit_breaker.py` with state machine, updated `validation/config.py` with dlq_retention_days, tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-queue-processor-retry/04-RESEARCH.md

# Config to extend
@validation/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create circuit breaker state machine</name>
  <files>worker/circuit_breaker.py, tests/test_circuit_breaker.py</files>
  <action>
Create `worker/circuit_breaker.py` with:

1. CircuitState enum: CLOSED, OPEN, HALF_OPEN
2. CircuitBreaker class with:
   - __init__(failure_threshold=5, recovery_timeout=60.0, success_threshold=1)
   - can_execute() -> bool: Returns True if circuit allows execution
   - record_success(): Resets failure count, closes circuit if HALF_OPEN
   - record_failure(): Increments failure count, opens circuit if threshold reached
   - state property: Current CircuitState
   - reset(): Force reset to CLOSED state (for testing/recovery)

State machine logic:
- CLOSED: Normal operation, count failures. Open after failure_threshold consecutive failures.
- OPEN: Reject all requests. Transition to HALF_OPEN after recovery_timeout elapsed.
- HALF_OPEN: Allow one request. Success -> CLOSED. Failure -> OPEN.

Create `tests/test_circuit_breaker.py` with tests:
- test_initial_state_closed
- test_opens_after_threshold_failures
- test_blocks_when_open
- test_half_open_after_recovery_timeout
- test_success_closes_circuit
- test_failure_in_half_open_reopens
- test_reset_closes_circuit

Use time.time() for timestamps. Tests can mock time for determinism.
  </action>
  <verify>
```bash
python -m pytest tests/test_circuit_breaker.py -v
```
  </verify>
  <done>All 7 circuit breaker tests pass. CircuitBreaker correctly transitions between states based on success/failure/timeout.</done>
</task>

<task type="auto">
  <name>Task 2: Add DLQ retention config</name>
  <files>validation/config.py</files>
  <action>
Add to PlexSyncConfig:

```python
dlq_retention_days: int = Field(default=30, ge=1, le=365)
```

Update log_config() to include dlq_retention_days in output.

No validation changes needed - Pydantic Field handles range.
  </action>
  <verify>
```bash
python -c "from validation.config import PlexSyncConfig; c = PlexSyncConfig(plex_url='http://x:32400', plex_token='xxxxxxxxxxxx'); print(c.dlq_retention_days)"
# Should print: 30
```
  </verify>
  <done>PlexSyncConfig accepts dlq_retention_days with default=30, range 1-365.</done>
</task>

</tasks>

<verification>
```bash
# All tests pass
python -m pytest tests/test_circuit_breaker.py -v

# Config field works
python -c "from validation.config import PlexSyncConfig; c = PlexSyncConfig(plex_url='http://x:32400', plex_token='xxxxxxxxxxxx', dlq_retention_days=7); assert c.dlq_retention_days == 7; print('OK')"
```
</verification>

<success_criteria>
- [ ] CircuitBreaker class implements 3-state machine (CLOSED, OPEN, HALF_OPEN)
- [ ] can_execute() returns False when circuit is OPEN
- [ ] Circuit opens after failure_threshold consecutive failures
- [ ] Circuit transitions to HALF_OPEN after recovery_timeout
- [ ] PlexSyncConfig has dlq_retention_days field with default=30
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-queue-processor-retry/04-02-SUMMARY.md`
</output>
