---
phase: 04-queue-processor-retry
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - worker/backoff.py
  - tests/test_backoff.py
autonomous: true

must_haves:
  truths:
    - "Delay increases exponentially with retry count"
    - "Full jitter randomizes delay within [0, calculated_max]"
    - "Delay never exceeds configured cap"
    - "PlexNotFound uses longer base delay and higher cap"
  artifacts:
    - path: "worker/backoff.py"
      provides: "Delay calculation functions"
      exports: ["calculate_delay", "get_retry_params"]
    - path: "tests/test_backoff.py"
      provides: "Unit tests for backoff"
      min_lines: 40
  key_links:
    - from: "worker/backoff.py"
      to: "plex.exceptions.PlexNotFound"
      via: "isinstance check in get_retry_params"
      pattern: "isinstance.*PlexNotFound"
---

<objective>
Implement exponential backoff delay calculator with full jitter using TDD.

Purpose: Provides crash-safe delay calculation for retry orchestration. Full jitter prevents thundering herd when multiple jobs retry simultaneously after Plex outage.

Output: `worker/backoff.py` with tested delay functions, `tests/test_backoff.py` with comprehensive unit tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-queue-processor-retry/04-RESEARCH.md

# Existing exception hierarchy for PlexNotFound detection
@plex/exceptions.py
</context>

<feature>
  <name>Exponential Backoff with Full Jitter</name>
  <files>worker/backoff.py, tests/test_backoff.py</files>
  <behavior>
    calculate_delay(retry_count, base, cap, jitter_seed) -> float
    - Retry 0, base=5, cap=80: delay in [0, 5]
    - Retry 1, base=5, cap=80: delay in [0, 10]
    - Retry 2, base=5, cap=80: delay in [0, 20]
    - Retry 3, base=5, cap=80: delay in [0, 40]
    - Retry 4, base=5, cap=80: delay in [0, 80]
    - Retry 5, base=5, cap=80: delay in [0, 80] (capped)

    get_retry_params(error) -> tuple[base, cap, max_retries]
    - PlexNotFound: (30.0, 600.0, 12)  # ~2 hour window
    - Other TransientError: (5.0, 80.0, 5)  # Standard backoff

    Test cases with seeded random for determinism:
    - seed=42, retry=0, base=5 -> specific predictable value
    - Verify cap is respected at high retry counts
    - Verify PlexNotFound returns different params
  </behavior>
  <implementation>
    Use random.Random(seed) for testable jitter. Full jitter formula:
    delay = random.uniform(0, min(cap, base * 2^retry_count))

    No tenacity dependency needed - formula is simple enough.
    Store retry_count in job dict for crash safety (caller's responsibility).
  </implementation>
</feature>

<verification>
```bash
python -m pytest tests/test_backoff.py -v
```

All tests pass. Functions handle edge cases (retry_count=0, high retry counts, PlexNotFound detection).
</verification>

<success_criteria>
- [ ] RED: Tests written and failing (no implementation yet)
- [ ] GREEN: Minimal implementation passes all tests
- [ ] REFACTOR: Code cleaned up if needed, tests still pass
- [ ] calculate_delay returns values within expected bounds
- [ ] get_retry_params returns correct tuple for PlexNotFound vs other errors
- [ ] Tests use seeded random for deterministic verification
</success_criteria>

<output>
After completion, create `.planning/phases/04-queue-processor-retry/04-01-SUMMARY.md`
</output>
