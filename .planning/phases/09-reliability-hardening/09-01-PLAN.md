---
phase: 09-reliability-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - validation/limits.py
  - validation/sanitizers.py
  - worker/processor.py
  - tests/validation/test_limits.py
  - tests/validation/test_sanitizers.py
autonomous: true

must_haves:
  truths:
    - "Missing optional fields in Stash data clear existing Plex values (LOCKED decision)"
    - "Field length limits are enforced consistently across all metadata fields"
    - "Emoji characters are handled safely without causing crashes"
    - "List fields (performers, tags) are limited to prevent unbounded growth"
  artifacts:
    - path: "validation/limits.py"
      provides: "Centralized Plex field limit constants"
      exports: ["PLEX_LIMITS", "MAX_TITLE_LENGTH", "MAX_SUMMARY_LENGTH", "MAX_PERFORMERS", "MAX_TAGS"]
    - path: "validation/sanitizers.py"
      provides: "Enhanced sanitization with emoji handling"
      contains: "strip_emojis"
    - path: "worker/processor.py"
      provides: "LOCKED missing field handling implementation"
      contains: "edits['studio.value'] = ''"
    - path: "tests/validation/test_limits.py"
      provides: "Tests for field limit constants"
      min_lines: 40
    - path: "tests/validation/test_sanitizers.py"
      provides: "Tests for emoji handling"
      contains: "test_emoji"
  key_links:
    - from: "worker/processor.py"
      to: "validation/limits.py"
      via: "import PLEX_LIMITS"
      pattern: "from validation.limits import"
    - from: "validation/sanitizers.py"
      to: "validation/limits.py"
      via: "default max_length values"
      pattern: "from validation.limits import"
---

<objective>
Implement field limits module, LOCKED missing field handling, and enhanced sanitization for Phase 9 reliability hardening.

Purpose: Establish centralized field limits, enforce the user's LOCKED decision that missing optional fields clear existing Plex values, and add safe emoji handling to prevent crashes from malformed input.

Output: validation/limits.py with constants, updated sanitizers.py with emoji handling, updated processor.py with LOCKED missing field logic, comprehensive tests.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-reliability-hardening/09-RESEARCH.md
@validation/sanitizers.py
@validation/metadata.py
@worker/processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create field limits module and enhance sanitizers</name>
  <files>
    - validation/limits.py (create)
    - validation/sanitizers.py (modify)
    - tests/validation/test_limits.py (create)
    - tests/validation/test_sanitizers.py (modify)
  </files>
  <action>
Create `validation/limits.py` with centralized Plex field limit constants:

```python
"""
Plex API field length limits.

Conservative defaults based on practical testing and common usage patterns.
Plex does not officially document these limits, so we use safe values that
work reliably without causing UI issues or API errors.
"""

# Text field limits (characters)
MAX_TITLE_LENGTH = 255          # Scene/movie title
MAX_STUDIO_LENGTH = 255         # Studio name
MAX_SUMMARY_LENGTH = 10000      # Description/details
MAX_TAGLINE_LENGTH = 255        # Short tagline
MAX_PERFORMER_NAME_LENGTH = 255 # Individual performer name
MAX_TAG_NAME_LENGTH = 255       # Individual tag name

# List field limits (count)
MAX_PERFORMERS = 50             # Maximum performers per item
MAX_TAGS = 50                   # Maximum tags per item
MAX_COLLECTIONS = 20            # Maximum collections per item

# Convenience dict for programmatic access
PLEX_LIMITS = {
    'title': MAX_TITLE_LENGTH,
    'studio': MAX_STUDIO_LENGTH,
    'summary': MAX_SUMMARY_LENGTH,
    'tagline': MAX_TAGLINE_LENGTH,
    'performer_name': MAX_PERFORMER_NAME_LENGTH,
    'tag_name': MAX_TAG_NAME_LENGTH,
    'performers_count': MAX_PERFORMERS,
    'tags_count': MAX_TAGS,
    'collections_count': MAX_COLLECTIONS,
}
```

Update `validation/sanitizers.py` to add emoji handling:

1. Add `strip_emojis(text: str) -> str` function that removes emoji characters (Unicode category 'So' - Other Symbol) to prevent potential Plex display/encoding issues
2. Add optional `strip_emoji: bool = False` parameter to `sanitize_for_plex()` - default False to preserve emojis unless caller explicitly requests stripping
3. Import limits from validation/limits.py and use as defaults

Create `tests/validation/test_limits.py`:
- Test that all constants are positive integers
- Test that PLEX_LIMITS dict contains all expected keys
- Test imports work correctly

Update `tests/validation/test_sanitizers.py`:
- Add tests for `strip_emojis()` function covering common emojis (face, flag, symbol)
- Add tests for `sanitize_for_plex()` with `strip_emoji=True`
- Add tests for emoji preservation when `strip_emoji=False` (default)
  </action>
  <verify>
```bash
pytest tests/validation/test_limits.py tests/validation/test_sanitizers.py -v --no-cov
python3 -c "from validation.limits import PLEX_LIMITS, MAX_TITLE_LENGTH; print(f'MAX_TITLE={MAX_TITLE_LENGTH}')"
python3 -c "from validation.sanitizers import strip_emojis; print(strip_emojis('Hello World'))"
```
  </verify>
  <done>
- validation/limits.py exists with all constants
- sanitizers.py has strip_emojis() and updated sanitize_for_plex()
- All new tests pass
- Imports work from both modules
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement LOCKED missing field handling in processor</name>
  <files>
    - worker/processor.py (modify)
    - tests/worker/test_processor.py (modify)
  </files>
  <action>
Update `worker/processor.py` `_update_metadata()` method to implement the LOCKED user decision:

**LOCKED DECISION:** When Stash provides None/empty for an optional field, CLEAR the existing Plex value (don't preserve it).

Modify the field handling logic (around lines 616-654):

1. For scalar fields (title, studio, summary, tagline, date):
   - Check if field key exists in data dict (not just truthy value)
   - If key exists AND value is None or empty string -> set `edits['field.value'] = ''` to clear
   - If key exists AND value is present -> sanitize and set
   - If key does NOT exist -> do nothing (field not in sync job)

2. Update preserve_plex_edits mode to also respect clearing:
   - In preserve mode, only SKIP clearing if Plex already has a value
   - If clearing (None/empty from Stash), still clear even in preserve mode

Example logic for studio field:
```python
if 'studio' in data:
    studio_value = data.get('studio')
    if studio_value is None or studio_value == '':
        # LOCKED: Clear existing Plex value
        edits['studio.value'] = ''
        log_debug("Clearing studio (Stash value is empty)")
    else:
        sanitized = sanitize_for_plex(studio_value, max_length=MAX_STUDIO_LENGTH)
        if not self.config.preserve_plex_edits or not plex_item.studio:
            edits['studio.value'] = sanitized
```

3. For list fields (performers, tags):
   - If key exists AND value is None or empty list -> clear all existing (empty edit params)
   - If key exists AND value has items -> apply limits from validation/limits.py (MAX_PERFORMERS, MAX_TAGS)
   - Log warning if list was truncated due to limits

4. Import from validation/limits.py at top of file.

Update `tests/worker/test_processor.py`:
- Add test: missing optional field in data clears Plex value
- Add test: empty string in data clears Plex value
- Add test: None value in data clears Plex value
- Add test: field NOT in data dict does not clear Plex value
- Add test: list fields truncated at limits with warning
  </action>
  <verify>
```bash
pytest tests/worker/test_processor.py -v -k "clear" --no-cov
pytest tests/worker/test_processor.py -v --no-cov
python3 -c "from worker.processor import SyncWorker; print('Import OK')"
```
  </verify>
  <done>
- processor.py implements LOCKED decision: None/empty clears Plex values
- Field-not-present does NOT clear (preserves existing)
- List fields respect MAX_PERFORMERS and MAX_TAGS limits
- All tests pass including new clearing behavior tests
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for field limits and clearing</name>
  <files>
    - tests/integration/test_reliability.py (create)
  </files>
  <action>
Create `tests/integration/test_reliability.py` with integration tests for reliability hardening:

```python
"""Integration tests for reliability hardening - field limits and clearing."""

import pytest
from unittest.mock import MagicMock, patch

class TestFieldClearing:
    """Test LOCKED decision: missing optional fields clear Plex values."""

    def test_none_studio_clears_plex_studio(self, mock_plex_item, mock_config):
        """When Stash sends studio=None, existing Plex studio is cleared."""
        # Setup: Plex item has existing studio
        mock_plex_item.studio = "Existing Studio"

        # Action: Sync job with studio=None
        data = {'path': '/test.mp4', 'title': 'Test', 'studio': None}

        # Assert: edit called with studio.value = ''
        # ... implementation details

    def test_empty_performers_clears_plex_actors(self, mock_plex_item, mock_config):
        """When Stash sends performers=[], existing Plex actors are cleared."""
        # ...

    def test_field_not_in_data_preserves_plex_value(self, mock_plex_item, mock_config):
        """When field key not in data dict, existing Plex value preserved."""
        # ...

class TestFieldLimits:
    """Test field length and count limits."""

    def test_performers_truncated_at_max(self, mock_plex_item, mock_config):
        """More than MAX_PERFORMERS performers are truncated with warning."""
        # ...

    def test_long_title_truncated(self, mock_plex_item, mock_config):
        """Title longer than MAX_TITLE_LENGTH is truncated."""
        # ...

class TestEmojiHandling:
    """Test emoji handling in metadata."""

    def test_emoji_in_title_preserved_by_default(self):
        """Emojis in title are preserved by default."""
        # ...

    def test_emoji_stripping_when_enabled(self):
        """Emojis stripped when strip_emoji=True."""
        # ...
```

Tests should use existing fixtures from conftest.py where possible. Focus on:
1. LOCKED clearing behavior (None/empty clears, absent preserves)
2. List truncation with warnings
3. Emoji handling modes
  </action>
  <verify>
```bash
pytest tests/integration/test_reliability.py -v --no-cov
pytest tests/ -v --no-cov -x  # Full test suite
```
  </verify>
  <done>
- test_reliability.py exists with integration tests
- All clearing behavior tests pass
- All field limit tests pass
- Full test suite passes
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass
pytest tests/validation/test_limits.py tests/validation/test_sanitizers.py tests/worker/test_processor.py tests/integration/test_reliability.py -v --no-cov

# Import verification
python3 -c "from validation.limits import PLEX_LIMITS, MAX_PERFORMERS, MAX_TAGS; print(f'Limits: {MAX_PERFORMERS} performers, {MAX_TAGS} tags')"
python3 -c "from validation.sanitizers import sanitize_for_plex, strip_emojis; print('Sanitizers OK')"
python3 -c "from worker.processor import SyncWorker; print('Processor OK')"

# Verify LOCKED decision is implemented
grep -n "edits\['studio.value'\] = ''" worker/processor.py && echo "LOCKED clearing implemented"
```
</verification>

<success_criteria>
- validation/limits.py created with all Plex field limit constants
- sanitizers.py enhanced with strip_emojis() function
- processor.py implements LOCKED decision: None/empty in data clears Plex values
- Field not present in data dict preserves existing Plex value
- List fields truncated at MAX_PERFORMERS/MAX_TAGS with warnings
- All tests pass (new and existing)
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/09-reliability-hardening/09-01-SUMMARY.md`
</output>
